# Chapter 15: Deploying to the Cloud with AWS and Azure

## Overview

Cloud computing has shifted from on-premises platforms to private and public clouds. This chapter covers practical guidance for deploying applications using Amazon Web Services (AWS) and Microsoft Azure - two major public cloud providers.

### Key Benefits of Cloud Computing
- **Scalability**: Scale horizontally (more instances) or vertically (more CPU/memory)
- **Cost-effective**: Pay only for what you use
- **Reduced operational overhead**: No need to maintain on-premises infrastructure
- **High availability**: Built-in fault tolerance and redundancy

### Cloud Computing Metaphor
Public cloud services are like "application services on tap" - turn on the tap for more resources, turn off when no longer needed.

## Technical Requirements

To follow along with the practical examples, you'll need:

- AWS and Azure free accounts:
  - AWS free tier: https://aws.amazon.com/free
  - Microsoft Azure free account: https://azure.microsoft.com/en-us/free/
- Local Linux machine for CLI utilities
- Modern web browser (Chrome/Firefox)
- Linux command-line terminal with intermediate shell proficiency

> **Important Note**: Always shut down EC2 instances or Azure virtual machines after experimenting to avoid high bills.

## Working with AWS EC2

### Introduction to AWS EC2

AWS Elastic Compute Cloud (EC2) is a scalable computing infrastructure for running cloud applications. It's gained popularity due to outstanding performance, scalability, and cost-effective service plans.

### EC2 Instance Types

EC2 instances can be categorized by two perspectives:

#### 1. Provisioning
- **Computing power**: vCPU, memory (RAM), and storage capacity
- **Special capabilities**: GPU or FPGA for specific workloads
- Detailed information: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html

#### 2. Pricing Models
- **On-demand instances**: Pay per second without long-term commitments
- **Reserved instances**: Significant savings with long-term commitments (1-3 years)
- **Spot instances**: Lower prices for unused capacity
- **Dedicated instances**: Run in Virtual Private Cloud (VPC) for single account

### EC2 Availability Zones (AZs)

- **Regions**: Multiple locations around the globe (e.g., US West Oregon, Asia Pacific Mumbai)
- **Availability Zones**: One or more data centers within a region
- **Isolation**: Regions are completely isolated for fault tolerance
- **High Availability**: AZs are connected while providing fault-tolerant services

![AWS Management Console](Figure 15.1 – The AWS management console)

### Creating EC2 On-Demand Instances

#### Step-by-Step Process:

1. **Access AWS Console**
   - Log into https://console.aws.amazon.com
   - Navigate to EC2 service

![EC2 Dashboard](Figure 15.2 – The EC2 dashboard)

2. **Launch Instance**
   - Click "Launch instance" button
   - Configure instance settings

3. **Instance Configuration**

   **Name and Tags:**
   ![EC2 Instance Name](Figure 15.3 – Giving a name to the new EC2 instance)
   
   **Adding Tags:**
   ![EC2 Tags](Figure 15.4 – Adding tags to an EC2 instance)

   **Operating System Selection:**
   ![OS Selection](Figure 15.5 – Choosing the operating system for the EC2 instance)

   **Instance Type:**
   ![Instance Type](Figure 15.6 – Choosing an instance type – the t2.micro)

   **Network Settings:**
   ![Network Settings](Figure 15.7 – Setting up the network for the new EC2 instance)

   **Storage Configuration:**
   ![Storage Settings](Figure 15.8 – Setting up storage for the EC2 instance)

4. **Review and Launch**
   ![Instance Summary](Figure 15.9 – Summary of the new EC2 instance and the Launch instance button)

5. **SSH Key Pair Setup**
   ![SSH Key Pair](Figure 15.10 – Selecting or creating a certificate key pair for SSH access)

6. **Instance Running**
   ![Running Instance](Figure 15.11 – An EC2 instance in the running state)

### Reserved Instances

Reserved instances require upfront commitment but offer significant cost savings (up to 75%).

**Key Characteristics:**
- **Platform**: Operating system (e.g., Linux)
- **Tenancy**: Shared or dedicated hardware
- **Offering Class**: Standard or Convertible
- **Instance Type**: Specific EC2 type
- **Term**: 1-year or 3-year commitment
- **Payment Options**: All upfront, Partial upfront, No upfront

![Reserved Instance Purchase](Figure 15.12 – Purchasing a reserved EC2 instance)

### Spot Instances

- **Cost Savings**: Up to 90% discount compared to on-demand pricing
- **Availability Risk**: Can be terminated with 2-minute warning
- **Use Cases**: Non-critical tasks, batch processing, data analysis
- **Best For**: Workloads that can handle interruptions

### Dedicated Instances

Required for businesses with strict regulatory requirements:
- **Dedicated Instances**: Exclusive hypervisor access
- **Dedicated Hosts**: Fixed physical machines plus exclusive hypervisor
- **Use Cases**: Financial, health, governmental institutions

![Dedicated Instance](Figure 15.13 – Launching a dedicated EC2 instance)

![Dedicated Host](Figure 15.14 – Creating a dedicated EC2 host)

### EC2 Placement Groups

Control how instances are distributed across EC2 infrastructure:

#### Types:
1. **Cluster Placement Groups**
   - Single AZ placement
   - Low-latency, high-throughput communication
   - Best for: High-performance computing

2. **Spread Placement Groups**
   - Hardware isolation between instances
   - Best for: Critical applications requiring fault tolerance

3. **Partition Placement Groups**
   - Logical partitions with hardware isolation between partitions
   - Up to 7 instances per partition
   - Best for: Large distributed workloads

![Placement Group Creation](Figure 15.15 – Creating a placement group)

### EC2 Instance Lifecycle

![Instance Lifecycle](Figure 15.16 – The life cycle of an EC2 instance)

**States:**
- **PENDING**: Boot-up and initialization
- **RUNNING**: Instance is operational (billing starts)
- **REBOOTING**: Restart on same host
- **STOPPED**: No instance charges (storage charges apply)
- **HIBERNATING**: Faster startup than stopped state
- **TERMINATED**: All charges stop, instance deleted

### Connecting to EC2 Instances

#### SSH Connection
```bash
ssh -i SSH_KEY ec2-user@EC2_INSTANCE
```

**Components:**
- `SSH_KEY`: Private key file (.pem)
- `ec2-user`: Default username (varies by AMI)
- `EC2_INSTANCE`: Public IP or DNS name

![Instance IP and DNS](Figure 15.17 – The public IP address and DNS name of an EC2 instance)

**Set correct permissions:**
```bash
chmod 400 packt_aws_key.pem
```

**Example connection:**
```bash
ssh -i packt_aws_key.pem ubuntu@3.68.98.173
```

![SSH Connection](Figure 15.18 – Connecting with SSH to an EC2 instance)

#### File Transfer with SCP

**Upload file to instance:**
```bash
scp -i packt_aws_key.pem README.md ubuntu@3.68.98.173:~/
```

**Download file from instance:**
```bash
scp -i packt_aws_key.pem ubuntu@3.68.98.173:~/README.md .
```

### EC2 Storage Volumes

Two types of storage volumes:

#### 1. Instance Store Volumes
- **Physically attached** to EC2 instance
- **No additional cost** for root volume
- **Limited by instance type**
- **Data lost** when instance stops/terminates

#### 2. Elastic Block Store (EBS) Volumes
- **Network-attached storage**
- **Data persists** beyond instance lifecycle
- **Flexible and high-performing**
- **Automatic replication** within AZ
- **Encryption support**
- **CloudWatch monitoring** included

### Configuring EBS Storage

#### Creating and Attaching EBS Volume:

1. **Create Volume**
   ![EBS Volume Creation](Figure 15.19 – Creating an EBS volume)

2. **Attach to Instance**
   ![Attach EBS Volume](Figure 15.20 – Attaching the EBS volume to an EC2 instance)
   
   ![Instance ID Entry](Figure 15.21 – Entering the EC2 instance ID to attach the volume)

3. **Format and Mount**

   **List block devices:**
   ```bash
   lsblk
   ```
   ![Block Devices](Figure 15.22 – The local volumes in our EC2 instance)

   **Check filesystem:**
   ```bash
   sudo file -s /dev/xvdf
   ```

   **Create filesystem:**
   ```bash
   sudo mkfs -t xfs /dev/xvdf
   ```
   ![Filesystem Creation](Figure 15.23 – Creating a new filesystem)

   **Mount volume:**
   ```bash
   sudo mkdir /packt_drive
   sudo mount /dev/xvdf /packt_drive
   ```
   ![EBS Access](Figure 15.24 – Accessing the EBS volume)

#### Detaching EBS Volume:
```bash
sudo umount -d /dev/xvdf
```
Then detach through AWS console.

## Working with AWS CLI

### Installation

**Download and install:**
```bash
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

**Verify installation:**
```bash
aws --version
```

### Configuration

**Set up credentials:**
```bash
aws configure
```

![AWS CLI Configuration](Figure 15.25 – Configuring the local AWS CLI environment)

**Required information:**
- AWS Access Key ID
- AWS Secret Access Key
- Default region name
- Default output format

### Common AWS CLI Commands

#### Query Instances
```bash
# List all instances
aws ec2 describe-instances

# Filter by region
aws ec2 describe-instances --region eu-central-1

# Filter by tags
aws ec2 describe-instances \
  --filters "Name=tag-key,Values=env" \
  --filters "Name=tag-value,Values=packt"

# Extract specific fields with jq
aws ec2 describe-instances \
  --filters "Name=tag-key,Values=env" \
  --filters "Name=tag-value,Values=packt" | \
  jq '.Reservations[].Instances[] | { InstanceId, ImageId, BlockDeviceMappings }'
```

![Query Results](Figure 15.26 – Querying EC2 instances)

#### Create Instance
```bash
aws ec2 run-instances \
  --image-id ami-0faab6bdbac9486fb \
  --count 1 \
  --instance-type t3.micro \
  --key-name packt_aws_key \
  --security-group-ids sg-0aa7c8ef75503a9aa \
  --placement AvailabilityZone=eu-central-1b
```

![New Instance Console](Figure 15.28 – The new EC2 instance shown in the console)

#### Tag Instance
```bash
# Add name tag
aws ec2 create-tags \
  --resources i-091e2f515d15c3b0b \
  --tags Key=Name,Value=aws_packt_testing_2

# Add custom tag
aws ec2 create-tags \
  --resources i-0e1692c9dfdf07a8d \
  --tags Key=env,Value=packt
```

![Tagged Instances](Figure 15.29 – Querying EC2 instance IDs by tag)

![Console View](Figure 15.30 – Showing all instances in the EC2 console)

#### Terminate Instance
```bash
aws ec2 terminate-instances --instance-ids i-091e2f515d15c3b0b
```

![Termination](Figure 15.31 – Terminating an instance)

![Terminated State](Figure 15.32 – Showing the terminated instance in the EC2 console)

## Working with Microsoft Azure

### Introduction to Azure

Microsoft Azure is a public cloud service providing Infrastructure-as-a-Service (IaaS) for building and deploying applications. It accommodates users from small teams to large enterprises.

### Creating Virtual Machines

#### Step-by-Step Process:

1. **Access Azure Portal**
   - Go to https://portal.azure.com
   - Enable docked navigation menu

2. **Create Resource**
   - Click "Create a resource"
   - Choose "Compute" → "Ubuntu Server 22.04 LTS"

![Azure VM Creation](Figure 15.33 – Creating a virtual machine in Azure)

3. **Configure Resource Group**
   - Create new resource group: "packt-demo"
   - Resource groups collect related deployment assets

4. **Instance Details**
   ![Azure VM Setup](Figure 15.34 – Setting up the Azure virtual machine)
   
   - **Virtual machine name**: packt-ubuntu-demo
   - **Region**: France Central
   - **Size**: Impacts cost directly

5. **SSH Configuration**
   ![SSH Setup](Figure 15.35 – Enabling SSH authentication and access to the virtual machine)
   
   - **Username**: packt
   - **Key pair name**: packt-ubuntu-demo_key
   - **Inbound ports**: SSH, HTTP, HTTPS

6. **Validation and Deployment**
   ![VM Creation](Figure 15.36 – Creating the virtual machine)
   
   ![SSH Key Download](Figure 15.37 – Downloading the SSH private key for accessing the virtual machine)

7. **Deployment Success**
   ![Deployment Success](Figure 15.38 – Successfully deploying a virtual machine)
   
   ![Deployment Details](Figure 15.39 – Deployment details)

**Created Resources:**
- Virtual machine host
- Network interface
- IP address
- Virtual network
- Network Security Group (NSG)

### Connecting to Azure VM

**Set key permissions:**
```bash
chmod 400 packt-ubuntu-demo_key.pem
```

**SSH connection:**
```bash
ssh -i packt-ubuntu-demo_key.pem packt@20.19.173.232
```

![Azure SSH Connection](Figure 15.40 – Connecting to the Azure virtual machine)

### Managing Virtual Machines

#### Resizing Virtual Machines

**Process:**
1. Go to Virtual Machines → Select instance
2. Click "Size" under "Availability + Scale"
3. Choose new size (e.g., B1ls with 0.5 GB RAM)
4. Click "Resize"

![VM Resize](Figure 15.41 – Changing the size of a virtual machine)

**Note**: Azure will stop and restart the VM during resizing.

#### Adding Storage

**Process:**
1. Navigate to VM → "Disks" under Settings
2. Click "Create and attach a new disk"
3. Configure disk properties:
   - **LUN**: Auto-assigned
   - **Disk name**: packt-disk
   - **Storage Type**: Choose appropriate type
   - **Size**: 4 GB

![Add Disk](Figure 15.42 – Adding a new data disk)

**Initialize the disk:**
```bash
# SSH to VM
ssh -i packt-rhel.pem packt@20.19.173.232

# List block devices
lsblk
```

![Block Device List](Figure 15.43 – Identifying the block device for the new data disk)

**Format and mount:**
```bash
# Check if empty
sudo file -s /dev/sdc

# Create filesystem
sudo mkfs -t xfs /dev/sdc

# Create mount point and mount
sudo mkdir /packt
sudo mount /dev/sdc /packt
```

## Working with Azure CLI

### Installation

**Install Azure CLI:**
```bash
curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
```

**Get help:**
```bash
az help
```

### Authentication

**Login to Azure:**
```bash
az login
```

![Azure CLI Login](Figure 15.44 – Initializing the Azure CLI environment)

Follow the device login process with the provided code.

### Common Azure CLI Commands

#### Create Resource Group
```bash
az group create --name packt-dev --location francecentral
```

![Resource Group Creation](Figure 15.45 – Creating a new resource group)

#### Create Virtual Machine
```bash
az vm create \
  --resource-group packt-dev \
  --name packt-ubuntu-dev \
  --image Ubuntu2204 \
  --admin-username packt \
  --generate-ssh-keys
```

![Azure VM CLI Creation](Figure 15.46 – Creating a new virtual machine)

**Command options:**
- `--resource-group`: Resource group name
- `--name`: VM name
- `--image`: Linux distribution
- `--admin-username`: Administrator account
- `--generate-ssh-keys`: Auto-generate SSH keys

![Azure Portal View](Figure 15.47 – Viewing the virtual machines in the Azure portal)

#### VM Management Commands

**List all VMs:**
```bash
az vm list
```

**Show specific VM:**
```bash
az vm show \
  --resource-group packt-dev \
  --name packt-ubuntu-dev
```

**Redeploy VM:**
```bash
az vm redeploy \
  --resource-group packt-dev \
  --name packt-ubuntu-dev
```

**Delete VM:**
```bash
az vm delete \
  --resource-group packt-dev \
  --name packt-ubuntu-dev
```

## Summary

This chapter covered practical aspects of cloud deployment with AWS EC2 and Microsoft Azure:

### AWS EC2 Key Concepts:
- **Instance Types**: On-demand, Reserved, Spot, Dedicated
- **Regions and AZs**: Geographic distribution and fault tolerance
- **Placement Groups**: Control instance distribution
- **Storage**: Instance Store vs EBS volumes
- **Management**: Web console and CLI tools

### Azure Key Concepts:
- **Virtual Machines**: Compute resources with flexible sizing
- **Resource Groups**: Logical collection of related resources
- **Storage**: Data disks and managed disks
- **Management**: Portal interface and CLI tools

### Common Operations:
- Creating and configuring instances/VMs
- SSH connectivity and file transfer
- Storage management and scaling
- Automation through CLI tools
- Cost optimization strategies

Both platforms provide similar capabilities with pay-as-you-go pricing, elasticity, autoscaling, and comprehensive security features.

## Questions for Review

1. **What is an AZ?**
   - Availability Zone - one or more data centers within a region

2. **Performance comparison: t3.small vs t3.micro?**
   - t3.small offers better performance with more vCPU and memory

3. **EBS volume across AZs?**
   - No, EBS volumes must be in the same AZ as the EC2 instance

4. **SSH command for cloud instances?**
   ```bash
   ssh -i private_key.pem username@public_ip
   ```

5. **CLI commands for listing VMs:**
   - Azure: `az vm list`
   - AWS: `aws ec2 describe-instances`

6. **AWS CLI for launching instance:**
   ```bash
   aws ec2 run-instances --image-id ami-xxx --instance-type t3.micro --key-name mykey
   ```

7. **Azure CLI for deleting VM:**
   ```bash
   az vm delete --resource-group mygroup --name myvm
   ```

## Further Reading

- **AWS EC2**: https://docs.aws.amazon.com/ec2/index.html
- **Azure**: https://docs.microsoft.com/en-us/azure
- **AWS for System Administrators** by Prashant Lakhera, Packt Publishing
- **Learning AWS – Second Edition** by Aurobindo Sarkar and Amit Shah, Packt Publishing
- **Learning Microsoft Azure** by Geoff Webber-Cross, Packt Publishing