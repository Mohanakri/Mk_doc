# Infrastructure and Automation with Ansible

## Table of Contents
- [Introduction](#introduction)
- [Ansible Architecture](#ansible-architecture)
- [Installing Ansible](#installing-ansible)
- [Working with Ansible](#working-with-ansible)
- [Setting up Lab Environment](#setting-up-lab-environment)
- [Configuring Ansible](#configuring-ansible)
- [Ad hoc Commands](#ad-hoc-commands)
- [Ansible Playbooks](#ansible-playbooks)
- [Working with Secrets](#working-with-secrets)
- [Loops and Conditionals](#loops-and-conditionals)
- [Templates with Jinja2](#templates-with-jinja2)
- [Ansible Roles](#ansible-roles)

---

## Introduction

Ansible is a powerful tool for automating software provisioning, configuration management, and application deployment workflows. Initially developed by Michael DeHaan in 2012, Ansible was acquired by Red Hat in 2015 and is now maintained as an open source project.

### Key Features
- **Agentless architecture** - No need to install agents on managed hosts
- **SSH-based communication** - Uses secure SSH connections
- **Idempotent operations** - Running tasks multiple times yields the same result
- **Python-based** - Core framework written in Python
- **YAML configuration** - Human-readable configuration files

---

## Ansible Architecture

![Ansible Architecture Diagram](images/ansible-architecture.png)

### Core Components

1. **API and Core Framework**: Main libraries encapsulating Ansible's core functionality
2. **Plugins**: Additional libraries extending core functionality
   - Connection plugins (cloud connectors)
   - Test plugins (verifying response data)
   - Callback plugins (responding to events)
3. **Modules**: Encapsulate specific functions running on managed hosts
   - User module for managing users
   - Package module for managing software packages
4. **Inventory**: INI or YAML file describing hosts and groups
5. **Playbooks**: Execution files describing tasks targeting managed hosts
6. **CLI**: Command-line tools (ansible, ansible-playbook, ansible-doc)

### Infrastructure Layout

![Infrastructure Layout](images/infrastructure-layout.png)

The diagram shows:
- **Control Node**: Where Ansible is installed and runs
- **Managed Hosts**: Target servers being managed
- **SSH Connections**: Secure communication channels
- **Inventory**: Database of managed hosts
- **CMDB Integration**: Configuration Management Database integration

---

## Configuration Management

Configuration management enables administrators to:
- Group managed hosts into logical categories
- Run tasks against multiple hosts simultaneously
- Maintain consistent configurations across infrastructure
- Schedule regular maintenance tasks

### Idempotent Operations

An operation is **idempotent** when running it multiple times yields the same result as running it once.

**Example**: Creating a user
- First run: Creates the user
- Subsequent runs: No-operation (user already exists)

This prevents errors and ensures consistent system state.

---

## Installing Ansible

### Technical Requirements
- Python 3.8 or newer
- SSH connectivity to managed hosts
- OpenSSH server on managed hosts
- Minimum 6 physical + 6 virtual CPU cores (12 total)

### Installation Methods

#### Method 1: Using Package Manager (Ubuntu)
```bash
# Update repositories
sudo apt update

# Add Ansible PPA
sudo apt install -y software-properties-common
sudo apt-add-repository --update ppa:ansible/ansible -y

# Install Ansible
sudo apt install ansible -y

# Verify installation
ansible --version
```

#### Method 2: Using pip (Recommended)
```bash
# Check Python version
python3 --version

# Install pip if needed
curl -s https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python3 get-pip.py --user

# Install Ansible
python3 -m pip install --user ansible

# Verify installation
ansible --version
```

**Output Example:**
![Ansible Version Output](images/ansible-version.png)

---

## Setting up Lab Environment

### Lab Infrastructure
- **neptune**: Ansible control node
- **ans-web1, ans-web2**: Web servers
- **ans-db1, ans-db2**: Database servers
- **OS**: Ubuntu Server LTS
- **Resources**: 2 vCPUs, 2GB RAM, 20GB storage per VM

### Managed Hosts Setup

1. **Set hostname** (example for ans-web1):
```bash
sudo hostnamectl set-hostname ans-web1
```

2. **Disable sudo password**:
```bash
sudo visudo
# Add line: packt ALL=(ALL) NOPASSWD:ALL
```

### Control Node Setup

1. **Update /etc/hosts**:
```bash
127.0.0.1 neptune localhost
192.168.122.70 ans-web1
192.168.122.147 ans-web2
192.168.122.254 ans-db1
192.168.122.25 ans-db2
```

2. **SSH Key Authentication**:
```bash
# Generate key pair
ssh-keygen

# Copy keys to managed hosts
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-web1
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-web2
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-db1
ssh-copy-id -i ~/.ssh/id_rsa.pub packt@ans-db2

# Test connection
ssh packt@ans-web1
```

---

## Configuring Ansible

### Configuration File Hierarchy (Precedence Order)
1. `ANSIBLE_CONFIG` environment variable
2. `./ansible.cfg` (current directory)
3. `~/.ansible.cfg` (user home directory)
4. `/etc/ansible/ansible.cfg` (global)

![Configuration File Setup](images/ansible-config.png)

### Creating Project Structure
```bash
mkdir ~/ansible
cd ~/ansible
touch ansible.cfg
```

### Sample Configuration (ansible.cfg)
```ini
[defaults]
inventory = ./hosts
deprecation_warnings = False

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False
```

---

## Inventory Management

### INI Format Inventory (hosts file)
```ini
[webservers]
ans-web1
ans-web2

[databases]
ans-db1
ans-db2
```

![Inventory File Structure](images/inventory-ini.png)

### YAML Format Alternative
```yaml
all:
  children:
    webservers:
      hosts:
        ans-web1:
        ans-web2:
    databases:
      hosts:
        ans-db1:
        ans-db2:
```

### Inventory Validation
```bash
ansible-inventory -i ./hosts --list --yaml
```

![Inventory Output](images/inventory-output.png)

### Host Patterns and Groups
- **Ranges**: `ans-web[1:2]`, `172.16.191.[11:15]`
- **Default Groups**: `all`, `ungrouped`
- **Nested Groups**: Use `:children` suffix
- **Wildcards**: `ans-web*`

---

## Ad hoc Commands

Ad hoc commands execute single Ansible tasks for quick operations.

### General Syntax
```bash
ansible [OPTIONS] -m MODULE -a ARGS PATTERN
```

### Common Modules and Examples

#### Ping Module
```bash
# Test connectivity to all hosts
ansible -m ping all
```

![Ping Test Results](images/ping-test.png)

#### User Module
```bash
# Check if user exists
ansible -m user -a "name=packt state=present" all

# Create new user
ansible -m user -a "name=webuser state=present" webservers

# Delete user
ansible -m user -a "name=webuser state=absent remove=yes force=yes" webservers
```

![User Management](images/user-management.png)

#### Package Module
```bash
# Install nginx on web servers
ansible -m package -a "name=nginx state=present" webservers

# Install MySQL on database servers
ansible -m package -a "name=mysql-server state=present" databases
```

![Package Installation](images/package-install.png)

#### Service Module
```bash
# Restart nginx service
ansible -m service -a "name=nginx state=restarted" webservers

# Restart MySQL service
ansible -m service -a "name=mysql state=restarted" databases
```

![Service Management](images/service-restart.png)

#### System Updates
```bash
# Update Ubuntu packages
ansible -m apt -a "upgrade=dist update_cache=yes" webservers
```

#### Reboot Module
```bash
# Reboot hosts with extended timeout
ansible -m reboot -a "reboot_timeout=3600" webservers
```

![Reboot Operation](images/reboot-hosts.png)

### Command Options
- `-b, --become`: Enable privilege escalation
- `-K, --ask-become-pass`: Prompt for sudo password
- `-l, --limit`: Limit to specific hosts
- `-m`: Specify module
- `-a`: Module arguments

---

## Ansible Playbooks

Playbooks are YAML files containing one or more plays with ordered task lists.

### Basic Playbook Structure
```yaml
---
- name: Create User Playbook
  hosts: webservers
  become: yes
  tasks:
    - name: Create web user
      user:
        name: webuser
        state: present
```

![Simple Playbook](images/simple-playbook.png)

### Running Playbooks
```bash
ansible-playbook create-user.yml
```

![Playbook Execution](images/playbook-run.png)

### Playbook Options
- `-C, --check`: Dry run mode
- `-l, --limit`: Limit to specific hosts
- `--syntax-check`: Validate syntax only
- `-v`: Verbose output

### Variables in Playbooks

#### Play-level Variables
```yaml
---
- name: Create User with Variables
  hosts: webservers
  become: yes
  vars:
    username: webuser
    password: changeit!
  tasks:
    - name: Create user account
      user:
        name: "{{ username }}"
        password: "{{ password | password_hash('sha512') }}"
        state: present
```

![Variables in Playbooks](images/playbook-variables.png)

#### Variable Hierarchy (Precedence Order)
1. Global variables (--extra-vars, group_vars/all)
2. Group variables (group_vars/groupname)
3. Host variables (host_vars/hostname)
4. Play variables (vars directive)

#### Group Variables
Create `./group_vars/webservers.yml`:
```yaml
username: webuser
password: changeit!
```

![Group Variables](images/group-vars.png)

---

## Working with Secrets

Ansible Vault provides encryption for sensitive data.

### Protecting Sensitive Data

#### Create Encrypted File
```bash
# Create and encrypt passwords file
ansible-vault create passwords.yml
```

#### Sample Passwords File Structure
```yaml
webuser: { password: changeit! }
webadmin: { password: changeme! }
```

![Encrypted Passwords](images/encrypted-passwords.png)

#### Vault Operations
```bash
# View encrypted file
ansible-vault view passwords.yml

# Edit encrypted file
ansible-vault edit passwords.yml

# Change vault password
ansible-vault rekey passwords.yml

# Encrypt existing file
ansible-vault encrypt passwords.yml
```

### Using Secrets in Playbooks

```yaml
---
- name: Create Users with Vault Passwords
  hosts: webservers
  become: yes
  vars:
    password: "{{ vars[username]['password'] }}"
  tasks:
    - name: Load passwords from vault
      include_vars:
        file: passwords.yml
        
    - name: Create user with vault password
      user:
        name: "{{ username }}"
        password: "{{ password | password_hash('sha512') }}"
        state: present
```

![Vault Access](images/vault-access.png)

#### Running with Vault
```bash
# Prompt for vault password
ansible-playbook --ask-vault-pass create-user.yml

# Use password file
ansible-playbook --vault-password-file vault.pass create-user.yml
```

### Vault IDs for Multiple Secrets
```bash
# Create vault with ID
ansible-vault create --vault-id passwords@prompt passwords.yml

# Use vault ID in playbook
ansible-playbook --vault-id passwords@vault.pass playbook.yml
```

---

## Loops and Conditionals

### Loops for Task Iteration

#### Simple Loop Example
```yaml
---
- name: Create Multiple Users
  hosts: webservers
  become: yes
  vars:
    users:
      - webuser
      - webadmin
      - webdev
  tasks:
    - name: Create user accounts
      user:
        name: "{{ item }}"
        state: present
      loop: "{{ users }}"
```

![Loop Implementation](images/loop-playbook.png)

#### Complex Data Loops
```yaml
vars:
  users:
    - { name: webuser, comment: "Web User" }
    - { name: webadmin, comment: "Web Admin" }
tasks:
  - name: Create users with comments
    user:
      name: "{{ item.name }}"
      comment: "{{ item.comment }}"
      state: present
    loop: "{{ users }}"
```

### Conditional Tasks

#### Using Facts
```yaml
---
- name: Install OS-specific Updates
  hosts: all
  tasks:
    - name: Install Ubuntu updates
      apt:
        upgrade: dist
        update_cache: yes
      when: ansible_distribution == "Ubuntu"
      
    - name: Install Debian updates
      apt:
        upgrade: dist
        update_cache: yes
      when: ansible_distribution == "Debian"
```

![Conditional Tasks](images/conditional-tasks.png)

#### Using Magic Variables
```yaml
tasks:
  - name: Create web users
    user:
      name: "{{ item.name }}"
      state: present
    loop: "{{ users.webusers }}"
    when: "'webservers' in group_names"
    
  - name: Create database users
    user:
      name: "{{ item.name }}"
      state: present
    loop: "{{ users.dbusers }}"
    when: "'databases' in group_names"
```

![Magic Variables](images/magic-variables.png)

#### Register Variables
```yaml
tasks:
  - name: Count system users
    shell: "cat /etc/passwd | wc -l"
    register: user_count
    
  - name: Check user limit
    debug:
      msg: "Too many users: {{ user_count.stdout }}"
    when: user_count.stdout | int > 30
```

![Register Variables](images/register-variables.png)

---

## Templates with Jinja2

Templates enable dynamic file generation with host-specific content.

### Template Syntax
- Comments: `{# ... #}`
- Expressions: `{% ... %}`
- Variables: `{{ ... }}`

### Message of the Day Template

#### Template File (templates/motd.j2)
```jinja2
{# Message of the Day Template #}
{% set date = "2021-04-08" %}
{% set start_time = "02:00:00" %}
{% set end_time = "03:00:00" %}
{% set utc = "-08:00" %}
{% set fmt = "%Y-%m-%d %H:%M:%S" %}
{% set start_time_ = (date + " " + start_time) | strptime(fmt) %}
{% set end_time_ = (date + " " + end_time) | strptime(fmt) %}

{{ ansible_facts.fqdn }} ({{ ansible_facts.default_ipv4.address }}) will be down for maintenance on {{ start_time_.strftime('%A, %B %d, %Y') }}, between {{ start_time_.strftime('%I %p') }} - {{ end_time_.strftime('%I %p') }} (UTC{{ utc }}).
```

![MOTD Template](images/motd-template.png)

#### Template Playbook
```yaml
---
- name: Update Message of the Day
  hosts: all
  become: yes
  tasks:
    - name: Deploy MOTD template
      template:
        src: motd.j2
        dest: /etc/motd
        owner: root
        group: root
        mode: '0644'
```

![MOTD Playbook](images/motd-playbook.png)

#### Generated MOTD Output
![MOTD Result](images/motd-result.png)

### Hosts File Template

#### Template File (templates/hosts.j2)
```jinja2
127.0.0.1 {{ inventory_hostname }} localhost

{% for host in groups['all'] %}
{% if host != inventory_hostname %}
{{ hostvars[host].ansible_facts.default_ipv4.address }} {{ host }}
{% endif %}
{% endfor %}
```

![Hosts Template](images/hosts-template.png)

#### Hosts Playbook
```yaml
---
- name: Update Hosts File
  hosts: all
  become: yes
  tasks:
    - name: Deploy hosts template
      template:
        src: hosts.j2
        dest: /etc/hosts
        owner: root
        group: root
        mode: '0644'
```

#### Generated Hosts File
![Generated Hosts](images/generated-hosts.png)

---

## Ansible Roles

Roles bundle automated workflows into reusable units.

### Role Benefits
- **Encapsulation**: Standalone packaging for sharing
- **Separation of Concerns**: Parallel development capability
- **Manageability**: Better organization for large projects
- **Reusability**: Generic implementations with variables

### Role Directory Structure

#### Initialize Role
```bash
ansible-galaxy init create-users
```

![Role Directory](images/role-directory.png)

#### Directory Components
- `defaults/main.yml`: Default variables (lowest precedence)
- `files/`: Static files referenced in tasks
- `handlers/main.yml`: Event-triggered tasks
- `meta/main.yml`: Role metadata and dependencies
- `tasks/main.yml`: Main task list
- `templates/`: Jinja2 template files
- `tests/`: Test playbooks and inventory
- `vars/main.yml`: Internal variables (high precedence)

### Role Implementation

#### defaults/main.yml
```yaml
---
users_file: users-role.yml
passwords_file: users_passwords-role.yml
```

#### tasks/main.yml
```yaml
---
- name: Load users
  include_vars:
    file: "{{ users_file }}"
    
- name: Load passwords
  include_vars:
    file: "{{ passwords_file }}"
    
- name: Create user accounts
  user:
    name: "{{ item.username }}"
    comment: "{{ item.comment }}"
    password: "{{ passwords[item.username]['password'] | password_hash('sha512') }}"
    state: present
  loop: "{{ users.list }}"
  no_log: true
```

![Role Implementation](images/role-implementation.png)

### Using Roles

#### Method 1: Play-level Role
```yaml
---
- name: Deploy Users
  hosts: webservers
  become: yes
  roles:
    - create-users
```

#### Method 2: Task-level Role
```yaml
---
- name: Deploy Users with Task
  hosts: webservers
  become: yes
  tasks:
    - name: Create users using role
      include_role:
        name: create-users
```

![Role Usage](images/role-usage.png)

### Testing Roles

#### Test Playbook (tests/test.yml)
```yaml
---
- name: Test Create Users Role
  hosts: localhost
  connection: local
  become: yes
  roles:
    - create-users
```

#### Run Tests
```bash
ansible-playbook create-users/tests/test.yml
```

---

## Common Ansible Facts

### System Information Facts
- `ansible_distribution`: OS distribution (Ubuntu, CentOS, etc.)
- `ansible_distribution_version`: OS version
- `ansible_architecture`: System architecture (x86_64, etc.)
- `ansible_hostname`: System hostname
- `ansible_fqdn`: Fully qualified domain name

### Network Facts
- `ansible_all_ipv4_addresses`: All IPv4 addresses
- `ansible_default_ipv4.address`: Primary IPv4 address
- `ansible_default_ipv4.interface`: Primary network interface

### Hardware Facts
- `ansible_processor_cores`: Number of CPU cores
- `ansible_memtotal_mb`: Total memory in MB
- `ansible_memfree_mb`: Available memory in MB
- `ansible_devices`: Storage device information

### Gathering Facts
```bash
# View all facts for a host
ansible ans-web1 -m setup

# View specific fact
ansible ans-web1 -m setup -a "filter=ansible_distribution"
```

---

## Best Practices

### Security
- Use Ansible Vault for sensitive data
- Implement proper SSH key management
- Enable privilege escalation only when needed
- Use `no_log: true` for sensitive tasks
- Regular vault password rotation

### Playbook Design
- Start simple, add complexity gradually
- Use meaningful names for plays and tasks
- Implement proper error handling
- Test playbooks before production deployment
- Use check mode for validation

### Variable Management
- Follow consistent naming conventions
- Use group_vars and host_vars appropriately
- Document variable requirements
- Minimize hardcoded values
- Leverage variable precedence effectively

### Performance
- Use loops instead of multiple tasks
- Implement proper task dependencies
- Cache fact gathering when possible
- Use async tasks for long-running operations
- Monitor playbook execution time

---

## Troubleshooting

### Common Issues and Solutions

#### SSH Connection Problems
```bash
# Test SSH connectivity
ssh -vvv user@hostname

# Check SSH agent
ssh-add -l

# Regenerate SSH keys if needed
ssh-keygen -f ~/.ssh/id_rsa
```

#### Privilege Escalation Issues
```bash
# Test sudo access
ansible host -m ping -b

# Check sudoers configuration
sudo visudo
```

#### Inventory Problems
```bash
# Validate inventory syntax
ansible-inventory --list

# Test specific host
ansible hostname -m ping
```

#### Playbook Debugging
```bash
# Run in check mode
ansible-playbook playbook.yml --check

# Increase verbosity
ansible-playbook playbook.yml -vvv

# Start at specific task
ansible-playbook playbook.yml --start-at-task "task name"
```

---

## Useful Commands Reference

### Ansible CLI Commands
```bash
# List all modules
ansible-doc --list

# Get module documentation
ansible-doc module_name

# List inventory hosts
ansible --list-hosts all

# Gather facts
ansible hostname -m setup

# Run command on hosts
ansible group -a "command"
```

### Ansible-Playbook Commands
```bash
# Basic playbook run
ansible-playbook playbook.yml

# Dry run
ansible-playbook playbook.yml --check

# Limit to specific hosts
ansible-playbook playbook.yml --limit "web*"

# Skip tags
ansible-playbook playbook.yml --skip-tags "tag1,tag2"

# Run specific tags only
ansible-playbook playbook.yml --tags "tag1"
```

### Vault Commands
```bash
# Create encrypted file
ansible-vault create file.yml

# Edit encrypted file
ansible-vault edit file.yml

# View encrypted file
ansible-vault view file.yml

# Encrypt existing file
ansible-vault encrypt file.yml

# Decrypt file
ansible-vault decrypt file.yml
```

---

## Conclusion

This comprehensive guide covers the fundamental concepts of Ansible for infrastructure automation and configuration management. From basic ad hoc commands to complex playbooks with roles, templates, and vault integration, these concepts form the foundation for effective automation workflows.

Key takeaways:
- Ansible's agentless architecture simplifies deployment
- Idempotent operations ensure consistent system states
- Playbooks provide powerful automation capabilities
- Variables and templates enable flexible configurations
- Roles promote reusability and organization
- Security through Ansible Vault protects sensitive data

Continue exploring Ansible's extensive module library and community contributions to expand your automation capabilities.