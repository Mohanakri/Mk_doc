# Chapter 4: Managing Users and Groups

## Introduction

Linux is a **multiuser, multitasking operating system** where multiple users can access the system simultaneously while sharing platform resources. The kernel performs tasks for each user concurrently and independently, providing essential isolation and security mechanisms.

## Key Concepts

- **Permissions**: Control read, write, and execution access
- **Superuser (root)**: Complete access to operating system resources
- **UID**: User Identifier - unique identifier for each user
- **GID**: Group Identifier - unique identifier for each group

---

## Managing Users

### Types of Users

| User Type | Description | Characteristics |
|-----------|-------------|-----------------|
| **Normal Users** | General-purpose accounts | Limited system access, login shell, home directory |
| **System Users** | Service accounts | May lack login shell/home directory, security isolation |
| **Superusers** | Privileged accounts | Full system access, can manage other users |

### Understanding sudo

**sudo** stands for "superuser do" (or "substitute user do"):
- Allows permitted users to execute commands with superuser privileges
- Provides additional security layer over direct root access
- Most Linux distributions create a sudo-enabled user during installation

#### Checking sudo privileges:
```bash
sudo -v
```

**Error message for non-sudo users:**
```
Sorry, user julian may not run sudo on neptune.
```

---

## Creating, Modifying, and Deleting Users

### Creating Users

#### Method 1: Using `useradd`

**Basic syntax:**
```bash
useradd [OPTIONS] USER
```

**Simple user creation:**
```bash
sudo useradd julian
```

**User record in /etc/passwd:**
![Figure 4.1 – The user record created with useradd](images/figure_4_1.png)

**User record fields (colon-delimited):**
1. `julian` - Username
2. `x` - Encrypted password (stored in /etc/shadow)
3. `1001` - UID
4. `1001` - GID
5. `:` - GECOS field (empty)
6. `/home/julian` - Home directory
7. `/bin/sh` - Default shell

**Creating user with home directory:**
```bash
sudo useradd -m julian
```

**Creating user with full name:**
```bash
sudo useradd -m -c "Julian" julian
```

**Viewing user information:**
```bash
getent passwd julian
id julian
```

![Figure 4.2 – The UID information](images/figure_4_2.png)

#### Method 2: Using `adduser`

**Basic syntax:**
```bash
adduser [OPTIONS] USER
```

**Interactive user creation:**
```bash
sudo adduser alex
```

![Figure 4.5 – The adduser command](images/figure_4_5.png)

**Viewing created user:**
```bash
getent passwd alex
```

![Figure 4.6 – Viewing user information with getent](images/figure_4_6.png)

### Setting User Passwords

**Create/change password:**
```bash
sudo passwd julian
```

![Figure 4.3 – Creating or changing the user password](images/figure_4_3.png)

**View password hash (shadow file):**
```bash
sudo getent shadow julian
```

![Figure 4.4 – Information about the user from the shadow file](images/figure_4_4.png)

### Creating a Superuser

**Add user to sudo group:**
```bash
sudo usermod -aG sudo julian
```

**Verify sudo membership:**
```bash
id julian
```

![Figure 4.7 – Looking for the sudo membership of a user](images/figure_4_7.png)

**Switch to user:**
```bash
su - julian
```

### Viewing Users

**List all usernames:**
```bash
cat /etc/passwd | cut -d: -f1 | less
```

**Alternative with getent:**
```bash
getent passwd | cut -d: -f1 | column | less
```

![Figure 4.8 – Viewing usernames](images/figure_4_8.png)

### Modifying Users

**Basic syntax:**
```bash
usermod [OPTIONS] USER
```

**Example - comprehensive user modification:**
```bash
sudo usermod -c "Julian" -d /local/julian -m -s /bin/bash julian
```

**Command options:**
- `-c, --comment`: Full username (GECOS field)
- `-d, --home`: New home directory
- `-m, --move`: Move content to new location
- `-s, --shell`: Login shell

**Verify changes:**
```bash
getent passwd julian
```

![Figure 4.9 – The user changes reflected with getent](images/figure_4_9.png)

#### Other Modifications

**Change username:**
```bash
sudo usermod -l "balog" julian
```

**Lock user:**
```bash
sudo usermod -L julian
```

**Unlock user:**
```bash
sudo usermod -U julian
```

### Manual User Editing

**Edit /etc/passwd safely:**
```bash
sudo vipw
```

### Password Management

**Change password:**
```bash
sudo passwd julian
```

**Set password expiration (30 days):**
```bash
sudo chage -M 30 julian
```

**Force password change at next login:**
```bash
sudo chage -d 0 julian
```

### Deleting Users

**Delete user with home directory:**
```bash
sudo userdel -f -r julian
```

**Command options:**
- `-f, --force`: Remove all files in home directory
- `-r, --remove`: Remove home directory and mail spool

**Manual deletion:**
1. Edit /etc/passwd: `sudo vipw`
2. Edit /etc/shadow: `sudo vipw -s`
3. Remove home directory: `sudo rm -rf /home/julian`

---

## Managing Groups

### Group Types

**From user perspective:**
- **Primary Group**: User's initial login group (mandatory)
- **Supplementary Groups**: Additional group memberships (optional)

### Creating Groups

**Basic syntax:**
```bash
groupadd [OPTIONS] GROUP
```

**Create group:**
```bash
sudo groupadd developers
```

**View group information:**
```bash
cat /etc/group | grep developers
getent group developers
```

![Figure 4.10 – The group with default attributes](images/figure_4_10.png)

**Group record fields:**
1. `developers` - Group name
2. `x` - Encrypted password
3. `1003` - GID

**Create group with specific GID:**
```bash
sudo groupadd -g 1200 developers
```

### Group Passwords

**Set group password:**
```bash
sudo gpasswd developers
```

![Figure 4.11 – Creating a password for the developers group](images/figure_4_11.png)

**Remove group password:**
```bash
sudo gpasswd -r developers
```

![Figure 4.13 – Setting a new group password and removing a group password](images/figure_4_13.png)

### Modifying Groups

**Basic syntax:**
```bash
groupmod [OPTIONS] GROUP
```

**Change GID:**
```bash
sudo groupmod -g 1200 developers
```

**Change group name:**
```bash
sudo groupmod -n devops developers
```

**Verify changes:**
```bash
getent group devops
```

![Figure 4.12 – Verifying the group changes](images/figure_4_12.png)

### Deleting Groups

**Delete group:**
```bash
sudo groupdel devops
```

**Note**: Cannot delete a group that's a primary group for existing users.

![Figure 4.16 – Successful attempt to delete the group](images/figure_4_16.png)

### Manual Group Editing

**Edit /etc/group:**
```bash
sudo vigr
```

**Edit /etc/gshadow:**
```bash
sudo vigr -s
```

---

## Managing Users in Groups

### Adding Users to Groups

**Create multiple groups:**
```bash
sudo groupadd -g 1100 admin
sudo groupadd -g 1200 developers
sudo groupadd -g 1300 devops
```

**Create users with group assignments:**
```bash
sudo useradd -g admin -G developers,devops alex2
sudo useradd -g admin -G developers,devops julian2
```

**Verify group memberships:**
```bash
id alex2
id julian2
```

![Figure 4.17 – Assigning groups to new users](images/figure_4_17.png)

### Moving Users Between Groups

**Create managers group:**
```bash
sudo groupadd -g 1400 managers
```

**Add user to additional group (append):**
```bash
sudo usermod -a -G managers alex2
```

**Verify changes:**
```bash
id alex2
```

![Figure 4.18 – Verifying the secondary groups for the user](images/figure_4_18.png)

**Remove from secondary groups:**
```bash
sudo usermod -G managers alex2
```

**Remove from all secondary groups:**
```bash
sudo usermod -G '' alex2
```

![Figure 4.19 – Verifying the user has no secondary groups](images/figure_4_19.png)

**Change primary group:**
```bash
sudo usermod -g managers alex2
```

![Figure 4.20 – Verifying the user has been assigned to the new primary group](images/figure_4_20.png)

### Viewing Users and Groups

**List all groups:**
```bash
cat /etc/group | cut -d: -f1 | column | less
getent group | cut -d: -f1 | column | less
```

![Figure 4.22 – Retrieving all group names](images/figure_4_22.png)

**View specific group:**
```bash
getent group developers
```

![Figure 4.23 – Retrieving information for a single group](images/figure_4_23.png)

**List user's groups:**
```bash
groups alex
```

![Figure 4.24 – Retrieving group membership information of a user](images/figure_4_24.png)

**Current user's groups:**
```bash
groups
```

![Figure 4.25 – The current user's groups](images/figure_4_25.png)

### Group Login Sessions

**Switch group context:**
```bash
newgrp GROUP
```

**Example workflow:**
```bash
id julian          # Check current groups
su julian          # Switch to user
whoami            # Verify current user
groups            # Show current groups
id                # Show current IDs
id -g             # Show current group ID
newgrp developers # Switch to developers group
id -g             # Verify group change
```

![Figure 4.26 – A user with multiple group memberships](images/figure_4_26.png)
![Figure 4.27 – Getting the current user](images/figure_4_27.png)
![Figure 4.28 – Getting the current user's groups](images/figure_4_28.png)
![Figure 4.29 – Viewing the current user and GID information](images/figure_4_29.png)
![Figure 4.30 – Switching the group session](images/figure_4_30.png)

---

## Managing Permissions

### File and Directory Permissions

**Basic permission types:**
- **Read (r)**: View file content / List directory content
- **Write (w)**: Modify file content / Modify directory content
- **Execute (x)**: Run file / Enter directory

### Viewing Permissions

**Basic syntax:**
```bash
ls -l FILE|DIRECTORY
```

**Example:**
```bash
ls -l /etc/passwd
```

**Output:**
```
-rw-r--r-- 1 root root 2010 Mar  9 08:57 /etc/passwd
```

**Output breakdown:**
1. `-rw-r--r--` - File permissions
2. `1` - Number of hard links
3. `root` - Owner user
4. `root` - Owner group
5. `2010` - File size
6. `Mar 9 08:57` - Creation date/time
7. `/etc/passwd` - Filename

### Permission Structure

![Figure 4.31 – The file permission attributes](images/figure_4_31.png)

**10-character permission field:**
- **Character 1**: File type
- **Characters 2-4**: User owner permissions
- **Characters 5-7**: Group owner permissions  
- **Characters 8-10**: Other users permissions

#### File Type Attributes
- `d` - Directory
- `-` - Regular file
- `l` - Symbolic link
- `p` - Named pipe
- `s` - Socket
- `b` - Block device
- `c` - Character device

#### Permission Attributes & Octal Values
- `r` - Read permission (4)
- `w` - Write permission (2)  
- `x` - Execute permission (1)
- `-` - No permission (0)

### Permission Examples

**Common permission patterns:**

| Permissions | Octal | Description |
|-------------|--------|-------------|
| `rwx rwx rwx` | 777 | Full access for all |
| `rwx r-x r-x` | 755 | Full owner, read/execute others |
| `rwx r-x ---` | 750 | Full owner/group, no others |
| `rwx --- ---` | 700 | Full owner only |
| `rw- rw- rw-` | 666 | Read/write for all |
| `rw- rw- r--` | 664 | Read/write owner/group, read others |
| `rw- r-- r--` | 644 | Read/write owner, read others |
| `rw- --- ---` | 600 | Read/write owner only |

**Check octal value:**
```bash
stat --format '%a' /etc/passwd
```

### Changing Permissions

#### Using chmod (Relative Mode)

**Syntax components:**
- **Who**: `u` (user), `g` (group), `o` (others), `a` (all)
- **How**: `+` (add), `-` (remove), `=` (set exactly)
- **What**: `r` (read), `w` (write), `x` (execute)

**Examples:**
```bash
chmod o+w myfile        # Add write for others
chmod u-rw myfile       # Remove read/write for owner
chmod u-r,ug-w,o-rwx myfile  # Complex changes
```

![Figure 4.32 – Setting write permissions to all other users](images/figure_4_32.png)
![Figure 4.33 – Removing read-write permissions for owner](images/figure_4_33.png)
![Figure 4.34 – A relatively complex invocation of chmod in relative mode](images/figure_4_34.png)

#### Using chmod (Absolute Mode)

**Octal values:**
- `7` = `rwx` (4+2+1)
- `6` = `rw-` (4+2)
- `5` = `r-x` (4+1)
- `4` = `r--` (4)
- `3` = `-wx` (2+1)
- `2` = `-w-` (2)
- `1` = `--x` (1)
- `0` = `---` (0)

**Example:**
```bash
chmod 777 myfile
```

![Figure 4.35 – The chmod invocation in absolute mode](images/figure_4_35.png)

### Changing Ownership

#### Using chown

**Basic syntax:**
```bash
chown [OPTIONS] [OWNER][:[GROUP]] FILE
```

**Examples:**
```bash
sudo chown julian:developers myfile    # Change user and group
sudo chown -R julian:julian mydir/     # Recursive change
```

![Figure 4.36 – A simple invocation of the chown command](images/figure_4_36.png)
![Figure 4.37 – Invoking ls and chown in recursive mode](images/figure_4_37.png)

#### Using chgrp

**Basic syntax:**
```bash
chgrp [OPTIONS] GROUP FILE
```

**Example:**
```bash
sudo chgrp developers myfile
```

![Figure 4.38 - Using chgrp to change group ownership](images/figure_4_38.png)

### Default Permissions (umask)

**Default umask values:**
- Regular user: `0002`
- Root user: `0022`

**Permission calculations:**
- **Files**: `0666 - umask`
- **Directories**: `0777 - umask`

**Examples:**
```bash
touch myfile2
stat --format '%a' myfile2  # Shows 664

mkdir mydir2  
stat --format '%a' mydir2   # Shows 775
```

**Common umask values:**

![Figure 4.39 – Typical umask values on Linux](images/figure_4_39.png)

### Special Permissions

**Special permission flags:**
- **setuid** (4): Run with file owner privileges
- **setgid** (2): Run with file group privileges  
- **sticky** (1): Restrict deletion in directory

#### setuid Permission

**Set setuid:**
```bash
chmod u+s myscript.sh
```

**Result**: `-rwsrwxr-x` (4775)

![Figure 4.40 – The setuid permission](images/figure_4_40.png)

#### setgid Permission

**Set setgid:**
```bash
chmod g+s myscript.sh
```

**Result**: `-rwxrwsr-x` (2775)

![Figure 4.41 – The setgid permission](images/figure_4_41.png)

#### Sticky Permission

**Set sticky bit:**
```bash
chmod +t mydir
```

**Result**: `drwxrwxr-t` (1775)

![Figure 4.42 – The sticky permission](images/figure_4_42.png)

---

## Summary

This chapter covered essential Linux user and group management concepts:

- **User Types**: Normal, system, and superusers
- **User Management**: Creating, modifying, and deleting users
- **Group Management**: Creating and managing groups
- **Permission System**: Read, write, execute permissions
- **Special Permissions**: setuid, setgid, sticky bit
- **Command-line Tools**: useradd, usermod, groupadd, chmod, chown

### Key Commands Reference

| Command | Purpose |
|---------|---------|
| `useradd` | Create users |
| `usermod` | Modify users |
| `userdel` | Delete users |
| `groupadd` | Create groups |
| `groupmod` | Modify groups |
| `groupdel` | Delete groups |
| `chmod` | Change permissions |
| `chown` | Change ownership |
| `chgrp` | Change group ownership |
| `passwd` | Set passwords |
| `id` | Show user/group IDs |
| `groups` | Show group memberships |

---

## Questions for Review

1. **What is a superuser?**
   - *Hint: Try `sudo`*

2. **Name two command-line utilities for creating users**
   - *Hint: Think about `adduser` and `useradd`*

3. **What is the octal value of `-rw-rw-r--` permissions?**
   - *Hint: r=4, w=2, x=1*

4. **What's the difference between primary and secondary groups?**

5. **How do you change ownership of a user's home directory?**

6. **Can you remove a user without deleting their home directory?**

---

## Further Reading

- Mastering Ubuntu Server – Fourth Edition, Jay LaCroix
- Red Hat Enterprise Linux 9 Administration – Second Edition
- Linux manual pages: `man useradd`, `man chmod`, `man chown`