# Chapter 10: Disaster Recovery, Diagnostics, and Troubleshooting

## Overview
This chapter covers essential skills for Linux system administrators including system backup/restore, disaster recovery planning, and troubleshooting common system issues. These skills are crucial for handling worst-case scenarios like power outages, theft, or hardware failures.

## Learning Objectives
- Planning for disaster recovery
- Backing up and restoring the system
- Introducing common Linux diagnostic tools for troubleshooting

## Technical Requirements
- Working Linux installation (Ubuntu 22.04.2 LTS Server/Desktop recommended)
- Optionally, two different systems on local network for some examples

---

## 1. Planning for Disaster Recovery

### Introduction to Risk Management

**What is Risk Management?**
Risk management comprises specific operations designed to mitigate any possible threat that could impact business continuity. It's crucial for every IT department.

### Historical Context
- Risk management frameworks originated in the US due to **FISMA** (Federal Information Systems Modernization Act) laws starting in 2002
- **NIST** (National Institute of Standards and Technology) began creating standards for cybersecurity assessments
- Major Linux distributions (Red Hat, SUSE, Canonical) have certifications from:
  - NIST (US)
  - NCSC (UK National Cyber Security Centre)
  - FSTEC (Russia's Federal Service for Technic and Export Control)

### NIST Risk Management Framework (SP 800-37r2)

The framework consists of **7 steps** with key branches:

1. **Inventory**: Thorough inventory of all on-premises systems and software solutions
2. **System Categorization**: Assesses impact level for each data type (availability, integrity, confidentiality)
3. **Security Control**: Detailed procedures for computer systems security (NIST SP800-53r4)
4. **Risk Assessment**: Covers threat identification, vulnerability identification, impact determination
5. **System Security Plan**: Report on security controls and future action assessments
6. **Certification & Authorization**: Review of security assessments and issue resolution
7. **Plan of Action**: Tool for tracking security weaknesses and response procedures

### Types of IT Risks

**Common Risk Categories:**
- Hardware failure
- Software errors
- Spam and viruses
- Human error
- Natural disasters (fires, floods, earthquakes, hurricanes)
- Criminal activities (security breaches, employee dishonesty, corporate espionage)

### Risk Management Strategy Steps

1. **Identifying Risk**: Identify possible threats and vulnerabilities
2. **Analyzing Risk**: Determine magnitude based on thorough studies
3. **Evaluating Risk**: Assess impact on operations
4. **Responding to Risk**: Activate disaster recovery plans (DRPs)
5. **Monitoring and Reviewing Risk**: Implement monitoring strategies

### Risk Calculation Terms

**Key Metrics:**
- **ALE** (Annual Loss Expectancy): Expected loss in 1 year
- **SLE** (Single Loss Expectancy): Expected loss at any given time
- **ARO** (Annual Rate of Occurrence): Likelihood of risky event in 1 year
- **Risk Formula**: `SLE × ARO = ALE`
- **MTBF** (Mean Time Between Failures): Time between anticipated repairable failures
- **MTTF** (Mean Time To Failure): Average time before irreparable failure
- **MTTR** (Mean Time To Restore): Time needed to repair affected system
- **RTO** (Recovery Time Objective): Maximum allocated downtime
- **RPO** (Recovery Point Objective): Time when system needs restoration

### Risk Strategy Types

**Proactive Actions:**
- **Risk Avoidance**: Quick solutions to prevent occurrence
- **Risk Mitigation**: Actions to reduce risk occurrence
- **Risk Transference**: Transfer risk outcome to external entity
- **Risk Deterrence**: Systems/policies to discourage attackers

**Non-Active Actions:**
- **Risk Acceptance**: Accept risk if mitigation costs exceed potential harm

### Cloud Computing Risk Considerations

**Cloud Service Models:**
- **SaaS** (Software as a Service): Slack, Microsoft 365, Google Apps, Dropbox
- **PaaS** (Platform as a Service): Azure, AWS Lambda, Google App Engine, Heroku
- **IaaS** (Infrastructure as a Service): OpenStack

**Cloud Risk Factors:**
- Data integration challenges
- Compatibility issues
- Responsibility transfer to third parties

### Designing a Disaster Recovery Plan (DRP)

**DRP Components:**
1. **Hardware Inventory**: Standardized hardware policy for easy replacement
2. **Software Applications Inventory**: Configured applications with limited user input
3. **Data Inventory**: Comprehensive data backup strategy
4. **Role Definition**: Clear responsibilities for team members
5. **Communication Strategy**: Clear procedures at all organizational levels
6. **Testing Schedule**: Thorough testing at least twice yearly

**Key Considerations:**
- Define tolerances for downtime and data loss
- Establish minimal acceptable RPO and RTO
- Prepare for both on-premises and multi-cloud environments
- Plan for succession and backup personnel

---

## 2. Backing Up and Restoring the System

### Backup Fundamentals

**The 3-2-1 Rule:**
- **3** copies of data
- **2** different media types at separate locations
- **1** backup always off-site (different geographical location)

**Variations:** 3-1-2, 3-2-2, 3-1-1, 3-2-3

**Essential Practices:**
- Regular backup checking for data integrity
- Clear and documented backup procedures
- Consider RTO and RPO factors

### Backup Types and Methods

![Figure 10.1 – Backup methods and types](backup_methods_types.png)

### Disk Cloning Solutions

#### The `dd` Command

Basic disk cloning tool that copies block by block regardless of filesystem type.

**Example Usage:**
```bash
# Clone entire disk (can take several hours)
sudo dd if=/dev/vda of=/dev/sda conv=noerror,sync status=progress
```

**Command Options:**
- `if=/dev/vda`: Input file (source drive)
- `of=/dev/sda`: Output file (destination drive)
- `conv=noerror`: Continue ignoring errors
- `sync`: Fill error blocks with zeros for data offset sync
- `status=progress`: Show transfer statistics

![Figure 10.2 – Using dd to clone an entire hard drive](dd_clone_drive.png)

#### The `ddrescue` Command

Advanced tool for copying from failing disks, copies good sectors first.

**Installation:**
```bash
sudo apt install gddrescue
```

**Usage:**
```bash
# Clone with error mapping
sudo ddrescue -n /dev/vda /dev/sda rescue.map --force
```

![Figure 10.3 – Using ddrescue to clone the hard drive](ddrescue_clone.png)

**Features:**
- Copies good sectors first, maps errors
- Can run multiple times to attempt bad sector recovery
- Creates rescue map for tracking progress

#### Using ReaR (Relax-and-Recover)

Enterprise-ready disaster recovery tool written in Bash.

**Installation:**
```bash
sudo apt install rear
```

**Configuration File:** `/etc/rear/local.conf`

##### Backing up to NFS Server

**Setup Steps:**

1. **Configure NFS Server:**
```bash
# Create backup directory
sudo mkdir /home/export/rear
sudo chown -R nobody:nogroup /home/export/rear/

# Edit /etc/exports
/home/export/rear 192.168.124.0/24(rw,sync,no_subtree_check)

# Restart NFS service
sudo systemctl restart nfs-kernel-server.service
```

2. **Configure ReaR Client (`/etc/rear/local.conf`):**
```bash
OUTPUT=ISO
OUTPUT_URL=nfs://192.168.124.112/home/export/rear
BACKUP=NETFS
BACKUP_URL=nfs://192.168.124.112/home/export/rear
```

3. **Create Backup:**
```bash
sudo rear -v -d mkbackup
```

**Output Files:**
- `rear-hostname.iso`: Bootable recovery image
- `backup.tar.gz`: Complete file system backup

##### Backing up to USB

**Setup Steps:**

1. **Format USB Drive:**
```bash
sudo rear format /dev/sda
```

![Figure 10.4 – Formatting the USB disk with ReaR](rear_format_usb.png)

2. **Configure for USB (`/etc/rear/local.conf`):**
```bash
OUTPUT=USB
BACKUP_URL="usb:///dev/disk/by-label/REAR-000"
```

3. **Verify USB Label:**
```bash
sudo ls -la /dev/disk/by-label/
```

![Figure 10.5 – Checking the URL location from the ReaR configuration file](rear_usb_label.png)

4. **Create USB Backup:**
```bash
sudo rear -v mkbackup
```

**Recovery Process:**
Boot from USB drive and select "Recover hostname" option.

---

## 3. Common Linux Diagnostic Tools for Troubleshooting

### Troubleshooting Categories
1. **Boot Issues**
2. **General System Issues**
3. **Network Issues**
4. **Hardware Issues**

### Tools for Boot Issues

#### Understanding the Boot Process

**Boot Order:**
1. **BIOS POST** (Power-On Self-Test)
2. **GRUB2 Bootloader** initialization
3. **GNU/Linux Kernel** initialization
4. **systemd Init System** initialization

#### Repairing GRUB2

**Steps for GRUB2 Repair:**

1. Boot from live USB/DVD
2. Open terminal and check disks:
```bash
sudo fdisk -l
```

3. Mount system partition:
```bash
sudo mount -t ext4 /dev/sda1 /mnt
```

4. Reinstall GRUB2:
```bash
sudo chroot /mnt
grub-install /dev/sda
grub-install --recheck /dev/sda
update-grub
```

5. Unmount and reboot:
```bash
exit
sudo umount /mnt
```

### Tools for General System Issues

#### Disk-Related Issues

**Essential Commands:**
- `du`: Shows disk space utilization for files/directories
- `df`: Shows disk usage for directories

**Check Disk Space:**
```bash
df -h
```

**Find Largest Directories:**
```bash
du -h /home | sort -hr | head -5
```

![Figure 10.6 – Finding the largest directories in your /home directory](find_largest_dirs.png)

**Check Inode Usage:**
```bash
df -i
```

![Figure 10.7 – inode usage statistics](inode_usage.png)

**Troubleshooting Steps:**
- Delete unnecessary files with `rm` command
- Move files to external storage with `rsync`
- Identify space-consuming directories

#### Memory Usage Issues

**Free Command:**
```bash
free -h
```

![Figure 10.8 – Using the free command in Linux](free_command.png)

**Memory Information:**
- **total**: Total memory amount
- **used**: Used memory (total - buffered - cache - free)
- **free**: Unused memory
- **shared**: Memory used by tmpfs
- **buff/cache**: Memory used by kernel buffers and page cache
- **available**: Memory available for new applications

**Top Command:**
```bash
top
```

![Figure 10.9 – Using the top command to check memory usage](top_memory.png)

**VMStat Command:**
```bash
vmstat
```

![Figure 10.10 – Using vmstat with no options](vmstat_basic.png)

**VMStat Memory Columns:**
- **swpd**: Virtual memory usage
- **free**: Free memory
- **buff**: Memory used for buffering
- **cache**: Memory used for caching

**Active/Inactive Memory:**
```bash
vmstat -a
```

![Figure 10.11 – Using vmstat -a to show the active and inactive memory](vmstat_active.png)

**SAR Command (System Activity Reporter):**

Installation:
```bash
sudo apt install sysstat
```

Enable service:
```bash
sudo systemctl start sysstat
sudo systemctl enable sysstat
```

![Figure 10.12 – Starting and enabling the service and running sar](sar_enable.png)

**Note:** Edit `/etc/default/sysstat` and change `ENABLED=false` to `ENABLED=true`

#### System Load Issues

**Uptime Command:**
```bash
uptime
```

![Figure 10.13 – Using uptime for checking system load](uptime_load.png)

**Load Average Interpretation:**
- Shows 1, 5, and 15-minute averages
- Load of 1.0 = 100% CPU utilization on single-core system
- Higher values indicate system stress

**Top Command Analysis:**

![Figure 10.14 – The output of the top command](top_detailed.png)

**CPU Time Types:**
- **us**: User CPU time
- **sy**: System CPU time  
- **ni**: Nice CPU time
- **id**: Idle CPU time
- **wa**: I/O wait time
- **hi**: Hardware interrupts time
- **si**: Software interrupts time
- **st**: CPU steal time

**IOStat Command:**
```bash
iostat
```

![Figure 10.15 – The output of iostat](iostat_output.png)

**I/O Statistics Columns:**
- **tps**: Transfers per second
- **kB_read/s**: Data read rate (KB/s)
- **kB_wrtn/s**: Data write rate (KB/s)
- **kB_dscd/s**: Data discarded rate (KB/s)
- **kB_read**: Total blocks read
- **kB_wrtn**: Total blocks written
- **kB_dscd**: Total blocks discarded

**IOTop Command:**
```bash
sudo apt install iotop
sudo iotop
```

![Figure 10.16 – Running the iotop command](iotop_output.png)

**SAR for CPU Load:**
```bash
sar 2 5
```

![Figure 10.17 – Running sar for CPU load troubleshooting](sar_cpu.png)

### Tools for Network Issues

Network troubleshooting follows TCP/IP layer approach:

#### Physical Layer (Layer 1)

**Ping Command:**
```bash
ping -c 4 google.com
```

![Figure 10.18 – Running a basic test using the ping command](ping_test.png)

**IP Link Status:**
```bash
ip link show
```

![Figure 10.19 – Showing the state of the physical interfaces with the ip command](ip_link_show.png)

**Bring Interface Up:**
```bash
ip link set wlp0s20f3 up
```

**Ethtool (check connection speed):**
```bash
ethtool enp1s0
```

#### Data Link Layer (Layer 2)

**ARP Command:**
```bash
sudo apt install net-tools
arp -a
```

![Figure 10.20 – Using the arp command to map the ARP entries](arp_entries.png)

**IP Neighbor Command:**
```bash
ip neighbor show
```

![Figure 10.21 – Listing the ARP entries using the ip command](ip_neighbor.png)

**Delete ARP Entry:**
```bash
ip neighbor delete 192.168.124.112 dev virbr0
```

#### Internet Layer (Layer 3)

**Routing Table:**
```bash
ip route show
```

![Figure 10.22 – Showing the routing table using the "ip route show" command](ip_route_show.png)

**Traceroute:**
```bash
sudo apt install traceroute
traceroute google.com
```

![Figure 10.23 – Using traceroute for path tracing](traceroute_path.png)

**Tracepath (newer alternative):**
```bash
tracepath google.com
tracepath -n google.com  # Show IPs instead of hostnames
```

![Figure 10.24 – Using the tracepath command](tracepath_output.png)

**DNS Resolution Testing:**
```bash
nslookup google.com
```

#### Transport & Application Layers (Layers 4 & 5)

**Socket Statistics (ss command):**
```bash
# Show TCP and UDP listening sockets
ss -tul
```

![Figure 10.25 – Using the ss command to list TCP and UDP sockets and all listening sockets](ss_sockets.png)

**Show TIME_WAIT Connections:**
```bash
ss -o state time-wait
```

![Figure 10.26 – Showing the TIME_WAIT ports with the ss command](ss_time_wait.png)

**SS Command Options:**
- `-t`: TCP sockets
- `-u`: UDP sockets
- `-l`: Listening sockets
- `-x`: Unix sockets
- `-o`: Show timer information

### Tools for Hardware Issues

#### DMIDecode Command

View hardware information using DMI (Desktop Management Interface) codes.

**Memory Information (Code 17):**
```bash
sudo dmidecode -t 17
```

![Figure 10.27 – Using dmidecode to view information about memory](dmidecode_memory.png)

**Other Useful Hardware Commands:**
- `lspci`: List PCI devices
- `lsblk`: List block devices
- `lscpu`: CPU information
- `dmesg`: Kernel messages

**Check Kernel Logs:**
```bash
dmesg | more
```

**Important DMI Codes:**
- **0**: BIOS information
- **1**: System information
- **4**: Processor information
- **17**: Memory device
- **19**: Memory array mapped address

For complete list: [DMI Codes Reference](https://www.thegeekstuff.com/2008/11/how-to-get-hardware-information-on-linux-using-dmidecode-command/)

---

## Summary

This chapter covered essential disaster recovery and troubleshooting skills:

**Key Topics Covered:**
1. **Risk Management**: Understanding NIST frameworks, risk calculation, and cloud considerations
2. **Disaster Recovery Planning**: Creating comprehensive DRPs with proper testing
3. **Backup Strategies**: Implementing 3-2-1 rule using dd, ddrescue, and ReaR
4. **System Diagnostics**: Tools for boot, system, network, and hardware troubleshooting

**Critical Skills Developed:**
- Risk assessment and management
- Backup and restore procedures
- Systematic troubleshooting approach
- Network diagnostics across TCP/IP layers
- Hardware issue identification

---

## Practice Questions

1. **Try to draft a DRP for your private network or small business**
2. **Back up your entire system using the 3-2-1 rule**
3. **Find your system's top 10 CPU-consuming processes**
4. **Find your system's top 10 RAM-consuming processes**

---

## Further Reading

- [Ubuntu LTS Official Documentation](https://ubuntu.com/server/docs)
- [RHEL Official Documentation](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/)
- [SUSE Official Documentation](https://documentation.suse.com/)
- [NIST Risk Management Framework](https://csrc.nist.gov/publications/detail/sp/800-37/rev-2/final)
- [NIST Security Controls](https://csrc.nist.gov/publications/detail/sp/800-53/rev-4/final)
- [TCP TIME_WAIT State](https://vincent.bernat.ch/en/blog/2014-tcp-time-wait-state-linux)
- [DMI Codes Reference](https://www.thegeekstuff.com/2008/11/how-to-get-hardware-information-on-linux-using-dmidecode-command/)