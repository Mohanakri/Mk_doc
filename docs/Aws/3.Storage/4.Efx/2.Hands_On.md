# AWS EFS (Elastic File System) Hands-On Real-Time Tasks

## Prerequisites

Before starting these hands-on tasks, ensure you have:
- AWS account with appropriate IAM permissions
- Basic understanding of EC2 instances
- AWS CLI configured (optional but recommended)
- SSH key pair for EC2 access

## Task 1: Create Your First EFS File System

### Objective
Create an Amazon EFS file system using the AWS Management Console.

### Steps

1. **Navigate to EFS Service**
   - Log into AWS Management Console
   - Go to Services → Storage → EFS (or search for "EFS")
   - Click "Create file system"

2. **Configure Basic Settings**
   - **Name**: Enter a descriptive name (e.g., `my-first-efs`)
   - **VPC**: Select your default VPC or create a new one
   - **Availability and Durability**: Choose "Regional" for multi-AZ redundancy
   - **Performance Mode**: Select "General Purpose" (default)
   - **Throughput Mode**: Choose "Provisioned" or "Bursting"

3. **Network Configuration**
   - Select subnets in different Availability Zones
   - Configure security groups (ensure NFS port 2049 is open)
   - Enable encryption at rest (recommended)

4. **Review and Create**
   - Review all settings
   - Click "Create" to provision the file system

### Expected Outcome
You should have a fully functional EFS file system with mount targets in multiple AZs.

---

## Task 2: Launch EC2 Instance and Mount EFS

### Objective
Create an EC2 instance and mount the EFS file system using the Launch Instance Wizard.

### Steps

1. **Launch EC2 Instance**
   - Navigate to EC2 Dashboard
   - Click "Launch Instance"
   - Choose Amazon Linux 2023 AMI
   - Select t3.micro instance type
   - Configure network settings in the same VPC as your EFS

2. **Configure Storage and EFS**
   - In the "Configure Storage" section
   - Click "Add File System"
   - Select your EFS file system
   - Choose mount point (e.g., `/mnt/efs`)
   - Enable automatic mounting

3. **Security Group Configuration**
   - Create or select a security group
   - Ensure SSH (port 22) is open for your IP
   - Add NFS rule (port 2049) for EFS communication

4. **Launch Instance**
   - Add your SSH key pair
   - Launch the instance

### Expected Outcome
EC2 instance with EFS automatically mounted at boot time.

---

## Task 3: Manual EFS Mount Using CLI

### Objective
Manually mount EFS on an existing EC2 instance using command line.

### Steps

1. **Connect to EC2 Instance**
   ```bash
   ssh -i your-key.pem ec2-user@your-ec2-public-ip
   ```

2. **Install EFS Utils**
   ```bash
   sudo yum update -y
   sudo yum install -y amazon-efs-utils
   ```

3. **Create Mount Directory**
   ```bash
   sudo mkdir -p /mnt/efs
   ```

4. **Mount EFS Using File System ID**
   ```bash
   # Method 1: Using EFS mount helper
   sudo mount -t efs fs-0123456789abcdef0:/ /mnt/efs
   
   # Method 2: Using EFS mount helper with encryption
   sudo mount -t efs -o tls fs-0123456789abcdef0:/ /mnt/efs
   ```

5. **Verify Mount**
   ```bash
   df -h | grep efs
   ls -la /mnt/efs
   ```

6. **Configure Automatic Mounting**
   ```bash
   # Edit fstab for persistent mounting
   sudo nano /etc/fstab
   
   # Add this line (replace with your file system ID)
   fs-0123456789abcdef0.efs.us-east-1.amazonaws.com:/ /mnt/efs efs defaults,_netdev 0 0
   ```

### Expected Outcome
EFS successfully mounted and accessible on the EC2 instance.

---

## Task 4: Test EFS Functionality Across Multiple Instances

### Objective
Demonstrate shared file system capabilities by mounting the same EFS on multiple EC2 instances.

### Steps

1. **Launch Second EC2 Instance**
   - Follow similar steps as Task 2
   - Ensure it's in the same VPC but different AZ
   - Mount the same EFS file system

2. **Test File Sharing**
   
   **On Instance 1:**
   ```bash
   # Create a test file
   echo "Hello from Instance 1" | sudo tee /mnt/efs/test-file.txt
   
   # Create a directory
   sudo mkdir /mnt/efs/shared-data
   
   # Set permissions
   sudo chmod 755 /mnt/efs/shared-data
   ```

   **On Instance 2:**
   ```bash
   # Verify file visibility
   cat /mnt/efs/test-file.txt
   ls -la /mnt/efs/
   
   # Add content from second instance
   echo "Hello from Instance 2" | sudo tee -a /mnt/efs/test-file.txt
   ```

3. **Real-time Synchronization Test**
   ```bash
   # On Instance 1 - monitor file changes
   tail -f /mnt/efs/test-file.txt
   
   # On Instance 2 - add content
   echo "Real-time update" | sudo tee -a /mnt/efs/test-file.txt
   ```

### Expected Outcome
Files created on one instance are immediately visible on all other instances sharing the EFS.

---

## Task 5: EFS Performance Testing

### Objective
Test and monitor EFS performance characteristics.

### Steps

1. **Install Performance Testing Tools**
   ```bash
   sudo yum install -y fio stress-ng
   ```

2. **Basic Write Performance Test**
   ```bash
   # Create test directory
   sudo mkdir -p /mnt/efs/performance-test
   cd /mnt/efs/performance-test
   
   # Write performance test
   sudo fio --name=write-test --ioengine=libaio --rw=write --bs=4k --size=1G --numjobs=1 --time_based --runtime=60s --group_reporting
   ```

3. **Read Performance Test**
   ```bash
   # Read performance test
   sudo fio --name=read-test --ioengine=libaio --rw=read --bs=4k --size=1G --numjobs=1 --time_based --runtime=60s --group_reporting
   ```

4. **Monitor EFS Metrics**
   - Navigate to CloudWatch in AWS Console
   - Search for EFS metrics
   - Monitor TotalIOBytes, DataReadIOBytes, DataWriteIOBytes
   - Set up CloudWatch alarms for performance thresholds

### Expected Outcome
Understanding of EFS performance characteristics and monitoring capabilities.

---

## Task 6: EFS with Docker Containers

### Objective
Use EFS as persistent storage for Docker containers.

### Steps

1. **Install Docker**
   ```bash
   sudo yum update -y
   sudo yum install -y docker
   sudo systemctl start docker
   sudo systemctl enable docker
   sudo usermod -a -G docker ec2-user
   ```

2. **Create Docker Container with EFS Volume**
   ```bash
   # Create application directory on EFS
   sudo mkdir -p /mnt/efs/webapp-data
   sudo chmod 777 /mnt/efs/webapp-data
   
   # Run container with EFS mount
   docker run -d \
     --name web-app \
     -p 80:80 \
     -v /mnt/efs/webapp-data:/var/www/html \
     nginx:latest
   ```

3. **Test Persistent Storage**
   ```bash
   # Create content in container
   echo "<h1>Hello from EFS Storage</h1>" | sudo tee /mnt/efs/webapp-data/index.html
   
   # Access web application
   curl http://localhost
   
   # Stop and restart container
   docker stop web-app
   docker start web-app
   
   # Verify data persistence
   curl http://localhost
   ```

### Expected Outcome
Container data persists across container restarts using EFS storage.

---

## Task 7: EFS Access Points Configuration

### Objective
Configure EFS Access Points for secure, application-specific access.

### Steps

1. **Create Access Point via Console**
   - Navigate to your EFS file system
   - Click "Access points" tab
   - Click "Create access point"

2. **Configure Access Point Settings**
   ```
   Name: webapp-access-point
   Root directory path: /webapp
   Creation info:
     - Owner UID: 1001
     - Owner GID: 1001
     - Permissions: 755
   POSIX user:
     - User ID: 1001
     - Group ID: 1001
   ```

3. **Mount Using Access Point**
   ```bash
   # Create mount directory
   sudo mkdir -p /mnt/efs-ap
   
   # Mount using access point
   sudo mount -t efs -o accesspoint=fsap-0123456789abcdef0 fs-0123456789abcdef0:/ /mnt/efs-ap
   
   # Test access
   ls -la /mnt/efs-ap
   touch /mnt/efs-ap/test-file
   ```

### Expected Outcome
Secure, isolated access to specific EFS directories through access points.

---

## Task 8: EFS Backup and Restore

### Objective
Implement automated backup strategy for EFS data.

### Steps

1. **Enable Automatic Backups**
   - Navigate to your EFS file system
   - Click "Backup" tab
   - Enable "Automatic backups"
   - Configure backup policy (daily, weekly, monthly)

2. **Create Manual Backup**
   ```bash
   # Using AWS CLI
   aws efs put-backup-policy \
     --file-system-id fs-0123456789abcdef0 \
     --backup-policy Status=ENABLED
   ```

3. **Test Backup Recovery**
   - Create test data on EFS
   - Navigate to AWS Backup console
   - Locate EFS backup
   - Initiate restore process
   - Verify data integrity

### Expected Outcome
Reliable backup and restore mechanism for EFS data protection.

---

## Task 9: Cross-Region EFS Replication

### Objective
Set up cross-region replication for disaster recovery.

### Steps

1. **Enable Replication**
   - Navigate to your source EFS file system
   - Click "Replication" tab
   - Click "Create replication"
   - Select destination region
   - Configure replication settings

2. **Monitor Replication Status**
   ```bash
   # Using AWS CLI
   aws efs describe-replication-configurations \
     --file-system-id fs-0123456789abcdef0
   ```

3. **Test Failover Scenario**
   - Create test data in source region
   - Verify replication to destination
   - Simulate failover by switching to destination region EFS

### Expected Outcome
Robust disaster recovery solution with cross-region EFS replication.

---

## Task 10: EFS Security and Encryption

### Objective
Implement comprehensive security measures for EFS.

### Steps

1. **Configure Encryption in Transit**
   ```bash
   # Mount with TLS encryption
   sudo mount -t efs -o tls,fsc fs-0123456789abcdef0:/ /mnt/efs-secure
   ```

2. **Implement EFS File System Policy**
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Principal": {
           "AWS": "arn:aws:iam::123456789012:root"
         },
         "Action": "elasticfilesystem:*",
         "Resource": "arn:aws:elasticfilesystem:us-east-1:123456789012:file-system/fs-0123456789abcdef0",
         "Condition": {
           "Bool": {
             "aws:SecureTransport": "true"
           }
         }
       }
     ]
   }
   ```

3. **Configure VPC Security Groups**
   ```bash
   # Create security group for EFS
   aws ec2 create-security-group \
     --group-name efs-security-group \
     --description "Security group for EFS access"
   
   # Add NFS rule for specific CIDR
   aws ec2 authorize-security-group-ingress \
     --group-name efs-security-group \
     --protocol tcp \
     --port 2049 \
     --cidr 10.0.0.0/16
   ```

### Expected Outcome
Fully secured EFS implementation with encryption and access controls.

---

## Troubleshooting Common Issues

### Mount Issues
```bash
# Check EFS mount helper logs
sudo tail -f /var/log/amazon/efs/*

# Verify security group rules
aws ec2 describe-security-groups --group-ids sg-xxxxxxxx

# Test network connectivity
telnet your-efs-dns-name.efs.region.amazonaws.com 2049
```

### Performance Issues
```bash
# Check EFS burst credits
aws efs describe-file-systems --file-system-id fs-xxxxxxxx

# Monitor I/O statistics
iostat -x 1

# Check for DNS resolution issues
nslookup your-efs-dns-name.efs.region.amazonaws.com
```

### Permission Issues
```bash
# Check file permissions
ls -la /mnt/efs/

# Verify user context
id

# Fix ownership issues
sudo chown -R ec2-user:ec2-user /mnt/efs/your-directory/
```

---

## Best Practices Summary

1. **Security**: Always use encryption in transit and at rest
2. **Performance**: Choose appropriate performance mode based on workload
3. **Cost**: Monitor usage and optimize throughput mode
4. **Backup**: Enable automatic backups for critical data
5. **Monitoring**: Set up CloudWatch alarms for key metrics
6. **Network**: Properly configure security groups and VPC settings
7. **Access**: Use access points for application-specific access control

---

## Additional Resources

- [AWS EFS Documentation](https://docs.aws.amazon.com/efs/)
- [EFS Performance Guidelines](https://docs.aws.amazon.com/efs/latest/ug/performance.html)
- [EFS Pricing Calculator](https://aws.amazon.com/efs/pricing/)
- [AWS EFS Workshops](https://workshops.aws/)

---

**Note**: Replace placeholder values (file system IDs, region names, IP addresses) with your actual AWS resource identifiers when executing these tasks.