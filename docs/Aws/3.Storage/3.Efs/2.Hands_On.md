# Amazon EFS Step-by-Step Tasks

## Project Requirement: Shared File Storage for Web Application

### Why EFS?
**Business Need**: A web application company needs shared storage that multiple EC2 instances can access simultaneously for:
- Storing uploaded user files (images, documents)
- Sharing configuration files across web servers
- Centralizing log files from multiple instances
- Ensuring data persistence during server scaling

## Task 1: Create EFS File System

### Why This Task?
Create a managed NFS file system that can be mounted on multiple EC2 instances simultaneously.

### Step-by-Step Process:

#### Console Steps:
1. **Login to AWS Console**
   - Navigate to AWS Management Console
   - Search for "EFS" in services

2. **Create File System**
   - Click "Create file system"
   - Click "Customize" for detailed configuration

3. **General Settings**
   ```
   Name: my-web-app-efs
   Performance mode: General Purpose (for most use cases)
   Throughput mode: Bursting (cost-effective for variable workloads)
   Encryption: Enable encryption at rest
   ```

4. **Network Settings**
   - Select your VPC
   - Choose 2+ Availability Zones for high availability
   - Select subnets in each AZ
   - We'll configure security groups in next step

5. **Review and Create**
   - Click "Create"
   - Note the File System ID (fs-xxxxxxxxx)

## Task 2: Configure Security Groups

### Why This Task?
EFS requires NFS protocol (port 2049) to be open between EC2 instances and EFS mount targets.

### Step-by-Step Process:

#### Create EFS Security Group:
1. **Navigate to EC2 â†’ Security Groups**
   - Click "Create security group"

2. **Configure EFS Security Group**
   ```
   Name: efs-mount-target-sg
   Description: Allow NFS access to EFS
   VPC: Select same VPC as EFS
   ```

3. **Add Inbound Rule**
   ```
   Type: NFS
   Protocol: TCP
   Port: 2049
   Source: Custom (we'll add EC2 security group next)
   ```

#### Create EC2 Security Group:
1. **Create EC2 Security Group**
   ```
   Name: ec2-efs-client-sg
   Description: EC2 instances that access EFS
   ```

2. **Add Rules**
   ```
   Inbound:
   - SSH (22) from My IP
   - HTTP (80) from Anywhere (for web server)
   
   Outbound:
   - NFS (2049) to efs-mount-target-sg
   ```

3. **Update EFS Security Group**
   - Go back to efs-mount-target-sg
   - Edit inbound rules
   - Set NFS source to ec2-efs-client-sg

## Task 3: Launch EC2 Instance with EFS Access

### Why This Task?
Create EC2 instances that will mount and use the EFS file system.

### Step-by-Step Process:

1. **Launch EC2 Instance**
   ```
   AMI: Amazon Linux 2
   Instance Type: t2.micro
   VPC: Same as EFS
   Subnet: Same AZ as one EFS mount target
   Security Group: ec2-efs-client-sg
   ```

2. **Connect to Instance**
   ```bash
   ssh -i your-key.pem ec2-user@instance-public-ip
   ```

3. **Install EFS Utils**
   ```bash
   sudo yum update -y
   sudo yum install -y amazon-efs-utils
   ```

## Task 4: Mount EFS File System

### Why This Task?
Mount the EFS file system to make it accessible to applications running on EC2.

### Step-by-Step Process:

1. **Create Mount Point**
   ```bash
   sudo mkdir /mnt/efs
   sudo mkdir /var/www/uploads  # For web app uploads
   ```

2. **Mount EFS (Method 1: Using EFS Helper)**
   ```bash
   # Replace fs-xxxxxxxxx with your EFS ID
   sudo mount -t efs fs-xxxxxxxxx:/ /mnt/efs
   ```

3. **Verify Mount**
   ```bash
   df -h
   # Should show EFS mount
   
   ls -la /mnt/efs
   # Should show empty directory
   ```

4. **Test Write Access**
   ```bash
   sudo touch /mnt/efs/test-file.txt
   echo "Hello EFS!" | sudo tee /mnt/efs/test-file.txt
   cat /mnt/efs/test-file.txt
   ```

## Task 5: Configure Automatic Mount on Boot

### Why This Task?
Ensure EFS is automatically mounted when EC2 instance restarts.

### Step-by-Step Process:

1. **Edit fstab File**
   ```bash
   sudo cp /etc/fstab /etc/fstab.backup
   sudo nano /etc/fstab
   ```

2. **Add EFS Entry to fstab**
   ```
   # Add this line (replace fs-xxxxxxxxx and region)
   fs-xxxxxxxxx.efs.us-east-1.amazonaws.com:/ /mnt/efs efs defaults,_netdev 0 0
   ```

3. **Test Automatic Mount**
   ```bash
   # Unmount first
   sudo umount /mnt/efs
   
   # Test automatic mount
   sudo mount -a
   
   # Verify
   df -h | grep efs
   ```

## Task 6: Test Multi-Instance Access

### Why This Task?
Verify that multiple EC2 instances can access the same EFS file system simultaneously.

### Step-by-Step Process:

1. **Launch Second EC2 Instance**
   - Same configuration as first instance
   - Same security group (ec2-efs-client-sg)
   - Different Availability Zone for testing

2. **Mount EFS on Second Instance**
   ```bash
   # On second instance
   sudo yum install -y amazon-efs-utils
   sudo mkdir /mnt/efs
   sudo mount -t efs fs-xxxxxxxxx:/ /mnt/efs
   ```

3. **Test Shared Access**
   ```bash
   # On Instance 1
   echo "Written from Instance 1" | sudo tee /mnt/efs/shared-test.txt
   
   # On Instance 2
   cat /mnt/efs/shared-test.txt
   echo "Modified from Instance 2" | sudo tee -a /mnt/efs/shared-test.txt
   
   # Back on Instance 1
   cat /mnt/efs/shared-test.txt
   # Should see both messages
   ```

## Task 7: Create EFS Access Point

### Why This Task?
Access Points provide application-specific entry points with POSIX permissions and path enforcement.

### Step-by-Step Process:

1. **Navigate to EFS Console**
   - Select your EFS file system
   - Click "Access points" tab
   - Click "Create access point"

2. **Configure Access Point**
   ```
   Name: web-app-uploads
   Root directory path: /uploads
   POSIX user:
   - User ID: 1001
   - Group ID: 1001
   Root directory creation:
   - Owner user ID: 1001
   - Owner group ID: 1001
   - Permissions: 0755
   ```

3. **Create Access Point**
   - Click "Create access point"
   - Note the Access Point ID (fsap-xxxxxxxxx)

4. **Mount Using Access Point**
   ```bash
   # Create new mount point
   sudo mkdir /var/www/uploads
   
   # Mount with access point
   sudo mount -t efs -o accesspoint=fsap-xxxxxxxxx fs-xxxxxxxxx:/ /var/www/uploads
   
   # Test access
   ls -la /var/www/uploads/
   sudo touch /var/www/uploads/test-upload.txt
   ```

## Task 8: Performance Testing

### Why This Task?
Validate that EFS performance meets application requirements.

### Step-by-Step Process:

1. **Install Performance Tools**
   ```bash
   sudo yum install -y fio
   ```

2. **Sequential Write Test**
   ```bash
   sudo fio --name=sequential-write \
            --rw=write \
            --bs=1M \
            --size=100M \
            --numjobs=1 \
            --filename=/mnt/efs/seq-test \
            --direct=1
   ```

3. **Random I/O Test**
   ```bash
   sudo fio --name=random-rw \
            --rw=randrw \
            --bs=4k \
            --size=50M \
            --numjobs=4 \
            --runtime=30 \
            --filename=/mnt/efs/random-test \
            --direct=1
   ```

4. **Concurrent Access Test**
   ```bash
   # On multiple instances simultaneously
   sudo fio --name=concurrent-test \
            --rw=write \
            --bs=64k \
            --size=50M \
            --numjobs=2 \
            --filename=/mnt/efs/concurrent-test-$(hostname) \
            --direct=1
   ```

## Task 9: Enable Backup

### Why This Task?
Protect data with automated backups for disaster recovery.

### Step-by-Step Process:

1. **Enable Automatic Backup**
   - Go to EFS Console
   - Select your file system
   - Click "Backup" tab
   - Click "Edit backup policy"
   - Enable "Automatic backups"
   - Set retention period (default: 35 days)

2. **Create On-Demand Backup**
   - Navigate to AWS Backup console
   - Click "Create backup job"
   - Select EFS as resource type
   - Choose your EFS file system
   - Configure backup settings

## Task 10: Monitor EFS Performance

### Why This Task?
Monitor file system performance and usage for optimization and troubleshooting.

### Step-by-Step Process:

1. **View EFS Metrics in CloudWatch**
   - Navigate to CloudWatch Console
   - Click "Metrics"
   - Select "EFS" namespace
   - View available metrics:
     - TotalIOBytes
     - DataReadIOBytes
     - DataWriteIOBytes
     - ClientConnections

2. **Create CloudWatch Alarm**
   ```
   Metric: TotalIOBytes
   Threshold: > 1GB per hour
   Action: Send SNS notification
   ```

3. **Enable VPC Flow Logs (Optional)**
   ```bash
   # Monitor NFS traffic
   aws ec2 create-flow-logs \
     --resource-type VPC \
     --resource-ids vpc-xxxxxxxxx \
     --traffic-type ALL \
     --log-destination-type cloud-watch-logs \
     --log-group-name VPCFlowLogs
   ```

## Task 11: Cleanup Resources

### Why This Task?
Remove resources to avoid ongoing charges after testing.

### Step-by-Step Process:

1. **Unmount EFS from All Instances**
   ```bash
   # On each instance
   sudo umount /mnt/efs
   sudo umount /var/www/uploads
   
   # Remove from fstab
   sudo nano /etc/fstab
   # Delete EFS lines
   ```

2. **Delete EFS Resources**
   - Delete Access Points first
   - Delete File System
   - Delete Security Groups
   - Terminate EC2 instances

3. **Verify Cleanup**
   - Check EFS console (should be empty)
   - Check EC2 instances (terminated)
   - Check security groups (deleted)

## Common Troubleshooting

### Mount Issues:
```bash
# Check security groups
sudo telnet fs-xxxxxxxxx.efs.region.amazonaws.com 2049

# Check DNS resolution
nslookup fs-xxxxxxxxx.efs.region.amazonaws.com

# Check EFS utils
rpm -qa | grep amazon-efs-utils
```

### Permission Issues:
```bash
# Check mount options
mount | grep efs

# Verify file permissions
ls -la /mnt/efs/

# Check user/group ownership
id
```

This step-by-step guide provides a complete hands-on experience with EFS, covering all essential tasks from basic setup to advanced configuration and monitoring.