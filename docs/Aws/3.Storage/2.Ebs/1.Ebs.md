# Amazon EBS (Elastic Block Store) Study Notes

## Overview

Amazon EBS is the Amazon Elastic Block Store, providing network-attached storage that can be attached to EC2 instances.

### Key Characteristics

- EBS volumes are network attached storage for EC2 instances
- Volume data persists independently of the instance lifecycle
- Volumes do not need to be attached to an instance
- Multiple EBS volumes can be attached to a single instance
- Single EBS volume can be attached to multiple instances (with constraints)
- For shared volumes across EC2 instances, use Amazon EFS instead
- Data is replicated across multiple servers in an Availability Zone
- Volumes must be in the same AZ as attached instances
- Designed for 0.1%-0.2% annual failure rate with 99.95% SLA

### Default Behaviors

- Termination protection is **OFF** by default (must be manually enabled)
- Root EBS volumes are **deleted** on termination by default
- Extra non-boot volumes are **NOT deleted** on termination by default
- Behavior can be changed via "DeleteOnTermination" attribute

### Features

- Volume sizes and types can be upgraded without downtime (except magnetic standard)
- Elastic Volumes allow size increase, performance adjustment, or type change while in use
- Auto-enable IO prevents stopping IO when AWS detects inconsistencies
- Root device created under `/dev/sda1` or `/dev/xvda`
- Can create AMIs with encrypted root/boot and data volumes
- Support for separate CMKs per volume

### Limits

- Up to 5,000 EBS volumes by default
- Up to 10,000 snapshots by default

## Instance Store vs EBS

### Instance Store
- Provides **temporary (non-persistent)** block-level storage
- Located on disks physically attached to host computer
- Ideal for frequently changing data (buffers, caches, scratch data)
- Can only be specified at instance launch
- Cannot detach/reattach to different instances
- Size determined by instance type
- Included in instance usage cost
- High performance, low latency
- Data lost if instance terminates or underlying host fails

**EXAM TIP**: Instance stores offer very high performance and low latency. Good for replicated/distributed databases needing high I/O. Cost included in instance charges, can be more cost-effective than EBS Provisioned IOPS.

### EBS vs Instance Store Comparison

| Aspect | EBS-backed | Instance Store-backed |
|--------|------------|----------------------|
| Root Volume | EBS volume | Instance store volume |
| Storage | Persistent | Non-persistent (Ephemeral) |
| Can be stopped | Yes (data preserved) | No (data lost) |
| Detach/Reattach | Yes | No |
| AMI Creation | From EBS snapshots | From templates on S3 |
| Reboot behavior | Data preserved | Data preserved |
| Default termination | Root deleted (configurable) | Root deleted |

## EBS Volume Types

### SSD, General Purpose (gp2/gp3)
- **Size**: 1 GiB to 16 TiB
- **IOPS**: Up to 16,000 per volume
- **Performance**: 
  - gp2: 3 IOPS/GiB
  - gp3: Up to 500 IOPS/GiB
- **Boot Volume**: Yes
- **Multi-attach**: Not supported
- **Use Cases**: Low-latency interactive apps, development/test environments

### SSD, Provisioned IOPS (io1/io2)
- **IOPS**: More than 16,000 (up to 64,000 on Nitro instances, 32,000 on others)
- **Performance**:
  - io1: Up to 50 IOPS/GiB
  - io2: Up to 500 IOPS/GiB
- **Boot Volume**: Yes
- **Multi-attach**: Supported
- **Use Cases**: Sustained IOPS performance, I/O-intensive database workloads

### HDD, Throughput Optimized (st1)
- **Throughput**: Up to 250 MiB/s per TB (burst), 40 MB/s per TB (baseline), 500 MiB/s max
- **Boot Volume**: No
- **Multi-attach**: Not supported
- **Use Cases**: MapReduce, Kafka, log processing, data warehouse, ETL workloads

### HDD, Cold (sc1)
- **Cost**: Lowest cost storage
- **Throughput**: Up to 80 MiB/s per TiB (burst), 12 MiB/s baseline
- **Boot Volume**: No
- **Multi-attach**: Not supported
- **Use Cases**: Less frequently accessed workloads with large, cold datasets

## EBS Optimized Instances

- Dedicated capacity for Amazon EBS I/O
- **Bandwidth**: 400 Mbps – 12,000 Mbps
- **IOPS**: 3,000 – 65,000
- GP-SSD and PIOPS within 10% of baseline/burst performance 99.9% of time
- Additional hourly fee
- Available for select instance types
- Some instances have EBS-optimized enabled by default

## EBS Snapshots

### Characteristics
- Capture point-in-time state of instance
- Cost-effective backup strategy
- Stored on Amazon S3
- Region-specific (volumes are AZ-specific)
- Incremental after first snapshot
- Only need most recent snapshot to restore volume
- Accessible only through EC2 APIs

### Snapshot Operations
- Can be taken of non-root volumes while running
- For consistent snapshots, writes must be stopped/paused
- For root volumes, instance must be stopped for consistency
- Can resize volumes when restoring from snapshots
- Can copy between regions (and encrypt during copy)
- Volumes created from snapshots must be same size or larger
- Cannot decrease EBS volume size

### Billing and Storage
- Charged for S3 data traffic and storage
- Billed only for changed blocks
- Deleting snapshot removes only data not needed by other snapshots

### Application-Consistent RAID Snapshots
To take application-consistent snapshots of RAID arrays:
1. Stop application from writing to disk
2. Flush all caches to disk
3. Freeze the filesystem
4. Unmount the RAID array
5. Shut down associated EC2 instance

## Encryption

### Supported Data Types
When EBS volume is encrypted, the following are encrypted:
- Data at rest inside the volume
- All data moving between volume and instance
- All snapshots created from the volume
- All volumes created from those snapshots

### Key Features
- Supported by all EBS volume types
- Same IOPS performance as unencrypted volumes
- All instance families support encryption
- Uses AES-256 algorithm
- Data key stored on-disk with encrypted data (encrypted with CMK)
- Same data key shared by snapshots and subsequent volumes

### Encryption Management
- Uses Customer Managed Keys (CMK) from AWS KMS
- Default CMK generated for first encrypted volume
- Subsequent volumes use unique keys
- Cannot change CMK for existing volume
- Cannot share encrypted volumes with default CMK
- Must use custom CMK for sharing encrypted snapshots

### Snapshot Sharing Rules
- **Unencrypted snapshots**: Can be public or shared with specific accounts
- **Encrypted snapshots**: Cannot be public, must use custom CMK
- Receiving account must copy snapshot before creating volumes
- Recommended to re-encrypt with own CMK

### Changing Encryption State
No direct way to change encryption state:
- Create encrypted volume and copy data, OR
- Take snapshot, encrypt it, create new encrypted volume from snapshot

## AMIs (Amazon Machine Images)

### Components
- Template for root volume (OS, application server, applications)
- Launch permissions controlling which accounts can use AMI
- Block device mapping specifying volumes to attach at launch

### Instance Store-backed AMIs
- Update root volume as required
- Create AMI → uploads to user-specified S3 bucket
- Register AMI with EC2 (creates EC2-controlled S3 image)
- To make changes: update source, deregister, reregister
- Image copied to EC2 host upon launch
- Volumes only created at launch time

### EBS-backed AMIs
- Must stop instance for consistent image creation
- AWS registers AMIs automatically
- Creates snapshots of all attached volumes during creation
- Cannot delete root volume snapshot if AMI is registered
- Can create AMIs with encrypted root/boot and data volumes

### Copying AMIs
- Can copy within or across AWS regions
- Supports both EBS-backed and instance store-backed AMIs
- Can copy encrypted AMIs and AMIs with encrypted snapshots

## RAID Configuration

### RAID Types
- **RAID 0**: Striping - increases performance, no redundancy
- **RAID 1**: Mirroring - creates 2 copies, adds redundancy only
- **RAID 10**: Combination of RAID 1 and 0 - performance + redundancy

### Implementation
- Configure through guest OS
- Can use multiple striped gp2, standard, or PIOPS volumes
- Not recommended for root/boot volumes
- Ensure EC2 instance can handle required bandwidth
- Use EBS optimized instances or 10 Gbps network interface

## Migration Between AZs

To migrate volumes between AZs:
1. Create snapshot of source volume
2. Create new volume in target AZ from snapshot
3. Can change size and type during migration

## Monitoring and Reporting

### CloudWatch Metrics
- **DiskReadBytes/DiskWriteBytes**: Instance Store volumes (AWS/EC2 namespace)
- **VolumeReadBytes/VolumeWriteBytes**: EBS volumes (AWS/EBS namespace)

### Monitoring Types
- **Basic**: 5-minute periods, no charge (includes root device volumes)
- **Detailed**: io1 volumes send 1-minute metrics automatically

### Volume Status Checks

| Volume Status | I/O Enabled Status | I/O Performance Status |
|---------------|-------------------|----------------------|
| ok | Enabled | Normal |
| warning | Enabled/Disabled | Degraded/Severely Degraded |
| impaired | Enabled/Disabled | Stalled/Not Available |
| insufficient-data | Enabled/Insufficient Data | Insufficient Data |

## Amazon Data Lifecycle Manager (DLM)

Automates creation, retention, and deletion of:
- EBS snapshots
- EBS-backed AMIs

### Benefits
- Enforce regular backup schedules
- Create standardized AMIs with regular refresh
- Retain backups for compliance
- Reduce storage costs by deleting outdated backups
- Create disaster recovery policies backing up to isolated accounts

## EBS Limits (per region)

| Resource | Default Limit |
|----------|---------------|
| Provisioned IOPS | 300,000 |
| Provisioned IOPS (SSD) storage | 300 TiB |
| General Purpose (SSD) storage | 300 TiB |
| Magnetic volume storage | 300 TiB |
| Cold HDD (sc1) storage | 300 TiB |
| Throughput Optimized HDD (st1) storage | 300 TiB |

## Logging and Auditing

- Integrated with AWS CloudTrail
- Captures all API calls as events
- Includes calls from console and code
- Provides record of actions by users, roles, or AWS services