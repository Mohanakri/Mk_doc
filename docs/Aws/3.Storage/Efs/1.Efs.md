# Amazon EFS (Elastic File System) Study Notes

## Overview

Amazon EFS is a fully managed service for hosting Network File System (NFS) filesystems in the cloud.

### Key Characteristics

- Implementation of NFS file share accessed using NFS protocol
- Provides elastic storage capacity with pay-for-what-you-use pricing model
- No pre-provisioning required (contrast to EBS where you pay for what you provision)
- Can scale up to petabytes
- Elastic - grows and shrinks as you add/remove data
- Fully managed service

### Accessibility and Connectivity

- Can configure mount-points in one or many AZs
- Up to thousands of Amazon EC2 instances can connect concurrently from multiple AZs
- File system can be accessed concurrently from all AZs in the region where it's located
- Instances can be behind an Elastic Load Balancer (ELB)
- Compatible with all Linux-based AMIs for Amazon EC2

### On-Premises Connectivity

- Can mount EFS filesystem from on-premises systems **ONLY** if using:
  - AWS Direct Connect, OR
  - VPN connection
- Mount using standard Linux mount command for NFS protocol
- Amazon VPC of connecting instance must have DNS hostnames enabled

### Common Use Cases

- Big data and analytics
- Media processing workflows
- Content management
- Web serving
- Home directories

## EFS vs EBS Comparison

| Feature | Amazon EFS | Amazon EBS Provisioned IOPS |
|---------|------------|------------------------------|
| **Availability & Durability** | Data stored redundantly across multiple AZs | Data stored redundantly in single AZ |
| **Access** | Up to thousands of EC2 instances from multiple AZs concurrently | Single EC2 instance in single AZ |
| **Use Cases** | Big data/analytics, media processing, content management, web serving, home directories | Boot volumes, transactional/NoSQL databases, data warehousing, ETL |
| **Per-operation Latency** | Low, consistent latency | Lowest, consistent latency |
| **Throughput Scale** | 10+ GB per second | Up to 2 GB per second |

## File System Properties

### Storage and Data Management

- Provides file system interface and access semantics (strong consistency, file locking)
- Data stored across multiple AZs within a region
- **Read after write consistency**
- Distributed across unconstrained number of storage servers
- Enables petabyte scale growth
- Supports massively parallel access from EC2 instances

### Mount Targets

- Need to create mount targets and choose AZs to include
- **Recommended to include all AZs**
- When mounting from EC2 instance, DNS name resolves to mount target's IP address
- Mount targets are endpoints in your VPC

## Performance Configuration

### Performance Modes

**General Purpose (Default)**
- Appropriate for most file systems
- Suitable for latency-sensitive use cases

**Max I/O**
- Optimized for applications where tens, hundreds, or thousands of EC2 instances access the file system
- Can achieve higher levels of aggregate throughput and IOPS
- Slightly higher latencies for file operations

### Throughput Modes

**Bursting Throughput (Default)**
- Throughput scales with file system size
- EFS designed to burst to allow high throughput levels for periods of time
- Baseline performance scales with storage size

**Provisioned Throughput**
- Throughput is fixed at the specified amount
- Independent of storage amount
- Pay for throughput provisioned above baseline rate

### Multithreaded and Concurrent Access

- Multithreaded applications can drive substantial aggregate throughput and IOPS
- Applications concurrently accessing data from multiple EC2 instances benefit from distributed architecture
- Design enables massive parallel access patterns

## Encryption

### Encryption at Rest

- **Must be enabled at file system creation time**
- Enable through:
  - EFS console
  - AWS CLI
  - SDKs
- Data transparently encrypted while being written
- Data transparently decrypted while being read
- Encryption keys managed by AWS Key Management Service (KMS)

### Encryption in Transit

- Uses **Transport Layer Security (TLS) 1.2**
- Encrypts data sent between clients and EFS file systems
- Enabled when mounting the file system
- Configuration done at mount time

### Encryption Configuration

- Encryption at rest and in transit can be configured:
  - Together (both enabled)
  - Separately (only one enabled)
- Keys managed by AWS KMS

## Access Control

### Mount Targets and DNS

- Create endpoints in VPC called "mount targets"
- File system's DNS name resolves to mount target's IP address
- DNS resolution happens during mount command execution

### Access Control Methods

**IAM-based Control**
- User-based policies
- Resource-based policies
- Control who can administer file system

**NFS Client Control**
- Resource-based policies control which NFS clients can access file systems

**POSIX Permissions**
- File and directory level permissions
- POSIX-compliant user and group-level permissions
- Restrict access from hosts by user and group

**Security Groups**
- Act as firewall for EFS
- Rules define traffic flow
- Control network-level access

## Backups and Lifecycle Management

### Automatic Backups

- **Enabled by default**
- Use AWS Backup service
- EFS-to-EFS Backup solution available
- Can schedule automatic incremental backups

### Lifecycle Management

- Automatically moves files to EFS Infrequent Access Storage class
- Files moved when not accessed for specified period of time
- Helps reduce storage costs for infrequently accessed data

## Monitoring and Reporting

### EFS Console Monitoring

The Amazon EFS console displays:
- Current metered size
- Number of mount targets
- Lifecycle state

### CloudWatch Metrics

Key metrics for monitoring:

**TotalIOBytes**
- Use daily Sum statistic to determine throughput
- Measures total bytes for all file system operations

**ClientConnections**
- Use daily Sum statistic to track number of connections from EC2 instances
- Monitor concurrent access patterns

**BurstCreditBalance**
- Monitor burst credit balance for bursting throughput mode
- Important for understanding performance capabilities

### Performance Monitoring

- Monitor throughput patterns and scaling
- Track IOPS performance across distributed storage servers
- Observe burst behavior and credit consumption

## Logging and Auditing

### AWS CloudTrail Integration

- Amazon EFS integrated with AWS CloudTrail
- CloudTrail captures all API calls for Amazon EFS as events
- Includes calls from:
  - Amazon EFS console
  - Code calls to Amazon EFS API operations
- Provides audit trail for file system management operations

## Architecture Considerations

### Multi-AZ Design

- Data automatically distributed across multiple AZs
- Provides high availability and durability
- Mount targets should be created in all AZs for optimal access

### Network Requirements

- VPC with DNS hostnames enabled
- Appropriate security group rules
- Network connectivity (Direct Connect or VPN for on-premises)

### Scalability

- No capacity planning required
- Automatically scales to petabyte levels
- Pay only for storage used
- Supports thousands of concurrent connections

## Best Practices

### Mount Target Strategy
- Create mount targets in all AZs where you have EC2 instances
- Ensures optimal performance and availability

### Performance Optimization
- Choose appropriate performance mode based on access patterns
- Use Provisioned Throughput for consistent, high-throughput requirements
- Monitor burst credits in Bursting mode

### Security
- Use IAM policies for administrative access control
- Implement POSIX permissions for fine-grained file access
- Configure security groups appropriately
- Enable encryption for sensitive data

### Cost Optimization
- Use lifecycle management to move infrequently accessed files to IA storage class
- Monitor storage usage and access patterns
- Consider throughput mode based on actual requirements