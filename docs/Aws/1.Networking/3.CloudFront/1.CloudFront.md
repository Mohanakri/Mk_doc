# Amazon CloudFront - Complete Study Notes

## Overview

Amazon CloudFront is a web service that provides businesses and web application developers an easy and cost-effective way to distribute content with low latency and high data transfer speeds.

### Key Features
- **Global Service**: Provides both ingress (upload objects) and egress (distribute content) capabilities
- **Content Types**: Supports dynamic, static, streaming, and interactive content
- **Performance**: Ideal for frequently accessed static content that benefits from edge delivery
- **Zone Apex Support**: Can use zone apex names and supports wildcard CNAME
- **SSL Support**: Supports wildcard SSL certificates, Dedicated IP, Custom SSL, and SNI Custom SSL

![Figure 1: CloudFront Global Distribution Network](https://digitalcloud.training/wp-content/uploads/2022/01/Amazon-CloudFront-Global-Network.jpg)

*Figure 1: Shows the worldwide network of edge locations and regional edge caches that form CloudFront's content delivery infrastructure, enabling low-latency content delivery to users globally*

## Edge Locations and Regional Edge Caches

### Edge Locations
- **Purpose**: Locations where content is cached (separate from AWS regions/AZs)
- **Routing**: Requests are automatically routed to the nearest edge location
- **Functionality**: Not just read-only - you can write to them too
- **Independence**: Not tied to Availability Zones or regions

### Regional Edge Caches
- **Position**: Located between origin web servers and global edge locations
- **Capacity**: Have larger cache-width than individual edge locations
- **Retention**: Objects remain in cache longer at these locations
- **Limitations**: 
  - Proxy methods (PUT/POST/PATCH/OPTIONS/DELETE) go directly to origin
  - Dynamic content bypasses Regional Edge caches

![Figure 2: Edge Location Architecture](https://digitalcloud.training/wp-content/uploads/2022/01/Amazon-CloudFront-Edge-Locations.jpg)
*Figure 2: Illustrates the hierarchical structure showing end users connecting to edge locations, which connect to regional edge caches, which then connect to origin servers (S3, EC2, ELB, or external origins)*

## Origins

An origin is the source of files that the CDN will distribute.

### Supported Origin Types
1. **Amazon S3 Bucket**
2. **EC2 Instance**
3. **Elastic Load Balancer**
4. **Route 53**
5. **External (non-AWS) servers**

### S3 as Origin
- Place all objects within the bucket
- Can use existing buckets without modification
- Default: All newly created buckets are private
- **Access Control Options**:
  - Bucket policies
  - Access Control Lists
  - Public objects or CloudFront signed URLs

### Custom Origin Servers
- Any HTTP server (EC2 instance or on-premises/non-AWS web server)
- Must specify DNS name, ports, and protocols
- Most CloudFront features supported (except RTMP distributions)

### S3 Static Website
- Enter S3 static website hosting endpoint
- Format: `http://<bucketname>.s3-website-<region>.amazonaws.com`
- Considered custom origins (not AWS origins)

### Caching and Availability
- **Default Cache Duration**: 24 hours
- **TTL Control**: Minimum expiration time is 0
- **Persistent Connections**: CloudFront maintains open connections with origin servers
- **High Availability**: Origin failover capability with primary and secondary origins

![Figure 3: Origin Types and Configuration](https://digitalcloud.training/wp-content/uploads/2022/01/Amazon-CloudFront-Origins.jpg)
*Figure 3: Displays the various origin types (S3 bucket, EC2, ELB, external servers) and how they connect to CloudFront distributions with their respective configuration options*

## Distributions

To distribute content with CloudFront, you must create a distribution containing CDN configuration.

### Distribution Configuration Includes
- Content origins
- Access (public or restricted)
- Security (HTTP or HTTPS)
- Cookie or query-string forwarding
- Geo-restrictions
- Access logs

### Distribution Types

#### Web Distribution
- **Content**: Static and dynamic content (.html, .css, .php, graphics)
- **Protocols**: HTTP and HTTPS
- **Capabilities**: Add, update, delete objects; submit web form data
- **Live Streaming**: Stream events in real time

#### RTMP Distribution
- **Purpose**: Distribute streaming media using Adobe Flash Media Server's RTMP protocol
- **Benefit**: Users can begin playing media before complete download
- **Requirement**: Files must be stored in S3 bucket

### For Media Serving
You need **two distributions**:
- Web distribution for the media player
- RTMP distribution for the media files

### Logging and Monitoring
- **S3 Access Logs**: Log all requests to S3 bucket
- **Amazon Athena**: Analyze access logs
- **CloudTrail Integration**: Captures all API requests
- **Global Services**: Must update CloudTrail to include global services

### Distribution Management
- **Deletion**: Must disable distribution first (takes up to 15 minutes)

![Figure 4: CloudFront Distribution Architecture](https://digitalcloud.training/wp-content/uploads/2022/01/Amazon-CloudFront-Distributions.jpg)
*Figure 4: Shows the relationship between distributions, origins, and the flow of content from origin through CloudFront to end users, including both web and RTMP distribution types*

## Cache Behavior

Allows configuration of CloudFront functionality for specific URL path patterns.

### Configurable Settings per Cache Behavior
- **Path Pattern**: e.g., `/images/*.jpg`, `/images*.php`
- **Origin Selection**: Which origin to forward requests to
- **Query String Forwarding**: Whether to forward query strings
- **Signed URLs**: Whether to require signed URLs
- **HTTP Methods**: Allowed HTTP methods
- **Minimum TTL**: Minimum cache retention time

### Default vs Additional Cache Behaviors
- **Default**: Only allows path pattern of `/*`
- **Additional**: Must be defined after distribution creation for custom path patterns

### Access Restriction Methods
- Signed cookies or signed URLs
- Restrict access to S3 bucket objects
- **Origin Access Identity (OAI)**: Special user to restrict direct S3 access

### Protocol Policies

#### Viewer Protocol Policy
- HTTP and HTTPS
- Redirect HTTP to HTTPS
- HTTPS only

#### Origin Policy
- HTTPS only
- Match viewer (matches protocol with custom origin)
- Use match viewer only with redirect or HTTPS-only viewer policies

### HTTP Methods Support
- **GET, HEAD** (basic)
- **GET, HEAD, OPTIONS** (extended)
- **GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE** (full)

### Security Features

#### Field-Level Encryption
- Additional security layer on top of HTTPS
- Protects specific data visible only to specific applications
- Encrypts sensitive information at the edge
- Maintains encryption throughout application processing

#### Object Invalidation
- Remove objects from cache
- Cannot cancel after submission
- Cannot invalidate Microsoft Smooth Streaming files
- Chargeable service

![Figure 5: Cache Behavior Configuration - Illustrates the cache behavior settings including path patterns, origin selection, HTTP methods, and security configurations that control how CloudFront handles different types of requests]

## Caching and Performance

### Cache Characteristics
- **Default TTL**: 24 hours (recorded in seconds)
- **Maximum TTL**: 1 year default maximum
- **Request Types**: Only caches GET requests (not PUT, POST, PATCH, DELETE)
- **Dynamic Content**: Also cached
- **Propagation**: Deletions propagate across edge locations

### Cache Hit Ratio Optimization

A good cache hit ratio means more requests served from cache.

#### Improvement Methods
- Use `Cache-Control max-age` directive to increase cache time
- Use Origin Shield
- Forward only necessary query string parameters
- Configure specific cookie forwarding instead of all cookies
- Forward and cache based on specific headers only

![Figure 6: Cache Performance Optimization - Shows the flow of requests through CloudFront's caching layers and the various optimization techniques to improve cache hit ratios and reduce origin load]

## Geographic Restrictions

### Geo-Restriction Options
- **CloudFront Native**: Restrict access to all files at country level
- **Third-party Service**: Restrict subset of files with finer granularity

### Implementation
- **Blacklists and Whitelists**: Can only use one at a time
- **Country Level**: Restriction granularity at country level

## Lambda@Edge

Run Lambda functions at Edge Locations for content customization.

### Supported Languages
- Node.js
- Python

### Execution Points
1. **Viewer Request**: After CloudFront receives request from viewer
2. **Origin Request**: Before CloudFront forwards request to origin
3. **Origin Response**: After CloudFront receives response from origin
4. **Viewer Response**: Before CloudFront forwards response to viewer

### Capabilities
- Inspect cookies and rewrite URLs for A/B testing
- Send specific objects based on User-Agent header
- Implement access control via header inspection
- Add, drop, or modify headers
- Generate new HTTP responses
- Support legacy URLs
- Modify headers/URLs to improve cache utilization
- Make HTTP requests to external resources

**Exam Tip**: Lambda@Edge can load different resources based on User-Agent HTTP header.

![Figure 7: Lambda@Edge Execution Points - Displays the four points in the request/response flow where Lambda@Edge functions can execute: viewer request, origin request, origin response, and viewer response]

## Access Control

### Signed URLs vs Signed Cookies

#### Signed URLs
**Use Cases**:
- Restrict access to individual files
- Users with clients that don't support cookies
- Installation downloads

**Features**:
- Include expiration date/time
- Based on canned or custom policy
- More control over content access

#### Signed Cookies
**Use Cases**:
- Provide access to multiple restricted files
- Don't want to change current URLs
- Subscribers' area access

**Implementation**:
- Application authenticates user
- Sends three Set-Cookie headers to viewer
- Viewer stores and includes in subsequent requests

### Origin Access Identity (OAI)

- **Purpose**: Special CloudFront user associated with distribution
- **Function**: Prevents bypassing CloudFront controls via direct S3 access
- **Implementation**: Change S3 bucket permissions to restrict access to OAI only
- **Result**: Direct S3 URL requests are denied; only CloudFront access allowed

![Figure 8: Access Control Methods - Illustrates the difference between signed URLs, signed cookies, and Origin Access Identity (OAI) implementations for controlling access to CloudFront content]

## Security Integration

### AWS WAF Integration

AWS WAF is a web application firewall for monitoring HTTP/HTTPS requests.

#### Control Conditions
- Origin IP address
- Values in query strings
- Custom web ACL rules

#### Responses
- Deliver requested content
- Return HTTP 403 (forbidden)
- Deliver custom error page

### Compliance and Security Features
- **PCI DSS Compliant**: Don't cache credit card information at edge locations
- **HIPAA Compliant**: Eligible service for HIPAA compliance

### DDoS Protection
- Distributes traffic across multiple edge locations
- Filters requests to ensure only valid HTTP(S) requests forward to backend
- Supports geo-blocking for geographic request filtering

## Domain Names and DNS

### Default Domain Names
- CloudFront creates domains like `a232323.cloudfront.net`

### Custom Domain Names
- **Route 53**: Use alias records for alternate domain names
- **Other Providers**: Use CNAME (cannot use zone apex with CNAME)

### Domain Movement
- **Subdomains**: Can move yourself
- **Root Domain**: Requires AWS support

## High Availability and Performance

### High Availability Features
- Content cached at Edge Locations worldwide
- Reduced origin server load through caching
- Lower latency through geographic distribution

### Origin Failover Setup
1. Distribution with at least two origins
2. Create origin group with primary and secondary origins
3. Create/update cache behavior to use origin group

## Monitoring and Reporting

### Default Metrics (No Additional Cost)
- **Requests**: Total viewer requests (all HTTP methods, HTTP/HTTPS)
- **Bytes Downloaded**: Total bytes downloaded via GET, HEAD, OPTIONS
- **Bytes Uploaded**: Total bytes uploaded via POST, PUT
- **4xx Error Rate**: Percentage of 4xx responses
- **5xx Error Rate**: Percentage of 5xx responses
- **Total Error Rate**: Percentage of 4xx or 5xx responses

### Additional Metrics (Additional Cost)
Enable separately for each distribution:
- **Cache Hit Rate**: Percentage of cacheable requests served from cache
- **Origin Latency**: Time from request receipt to response start (first byte latency)
- **Error Rate by Status Code**: Available for codes 401, 403, 404, 502, 503, 504

![Figure 9: CloudFront Monitoring Dashboard - Shows the various metrics and monitoring capabilities available for CloudFront distributions, including both default and premium metrics]

## Logging and Auditing

### Access Logging
- **S3 Buckets**: Configure access logs and cookie logs
- **Amazon Athena**: Analyze access logs
- **Log Content**: All requests made to S3 bucket

### CloudTrail Integration
- **Storage**: Saves logs to specified S3 bucket
- **Scope**: Captures all requests (console, API, SDKs, CLI, other services)
- **Information**: Request details, source IP, requester identity
- **Requirement**: Update existing trail to include global services for CloudFront requests

## Pricing and Charges

### What You Pay For
- **Data Transfer Out to Internet**
- **Data Transfer Out to Origin**
- **Number of HTTP/HTTPS Requests**
- **Invalidation Requests**
- **Dedicated IP Custom SSL**
- **Field-level Encryption Requests**

### What's Free
- **Data transfer between AWS regions and CloudFront**
- **Regional edge cache**
- **AWS ACM SSL/TLS certificates**
- **Shared CloudFront certificates**

### Reserved Capacity
- Available for 12+ months commitments
- Starts at 10TB data transfer in single region

![Figure 10: CloudFront Pricing Structure - Breaks down the various cost components and free services associated with CloudFront usage, including data transfer, requests, and security features]

## Best Practices and Exam Tips

### Performance Optimization
- Set appropriate TTL values based on content change frequency
- Use Origin Shield for better cache hit ratios
- Configure specific header and cookie forwarding
- Implement proper cache invalidation strategy

### Security Best Practices
- Use OAI to prevent direct S3 access
- Implement signed URLs/cookies for restricted content
- Enable field-level encryption for sensitive data
- Use AWS WAF for additional protection

### Monitoring and Troubleshooting
- Enable CloudTrail for comprehensive logging
- Use Amazon Athena for access log analysis
- Monitor cache hit ratios and error rates
- Set up appropriate alerts for performance metrics

### Cost Optimization
- Use reserved capacity for predictable workloads
- Optimize cache behaviors to reduce origin requests
- Leverage free features like regional edge caches
- Monitor data transfer patterns and optimize accordingly