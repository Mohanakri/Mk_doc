# Amazon VPC - AWS Study Notes

# Amazon VPC - AWS Study Notes

## Overview

Amazon VPC (Virtual Private Cloud) provides a logically isolated section of the AWS cloud where you can launch AWS resources in a virtual network that you define.

### Key Concepts
- **Analogous to**: Having your own data center inside AWS
- **Control**: Complete control over virtual networking environment
- **Scope**: Region-wide service
- **Isolation**: Logically isolated from other VPCs on AWS
- **Default Setup**: Default VPC created in each region with subnets in each AZ
- **Limits**: Up to 5 VPCs per region by default
- **Tenancy**: Can define dedicated tenancy to ensure instances launch on dedicated hardware

### Default VPC Characteristics
- Automatically created for each AWS account when EC2 resources are first provisioned
- Contains all-public subnets
- Instances always have both public and private IP addresses
- Public subnets have "Auto-assign public IPv4 address" set to "Yes" and route table attached to Internet Gateway

---

## VPC Components

### Core Components
- **Virtual Private Cloud**: Logically isolated virtual network with defined IP address space
- **Subnet**: Segment of VPC's IP address range for isolated resource groups (maps 1:1 to AZ)
- **Internet Gateway**: VPC side connection to public Internet
- **NAT Gateway**: Managed Network Address Translation service for private subnet Internet access
- **Router**: Interconnects subnets and directs traffic between gateways and subnets

### Connectivity Components
- **Hardware VPN Connection**: Hardware-based VPN between VPC and data center/home network
- **Virtual Private Gateway**: VPC side of VPN connection
- **Customer Gateway**: Customer side of VPN connection
- **Peering Connection**: Route traffic via private IPs between two peered VPCs
- **VPC Endpoints**: Private connectivity to AWS services without Internet Gateway/VPN/NAT
- **Egress-only Internet Gateway**: Stateful gateway for IPv6 egress-only access

### Connection Options
- Hardware-based VPN
- AWS Direct Connect
- VPN CloudHub
- Software VPN

---

## Routing

### VPC Router
- Performs routing between AZs within a region
- Connects different AZs together
- Connects VPC to Internet Gateway
- Each subnet has a route table for traffic forwarding

### Route Tables
- **Limits**: Up to 200 route tables per VPC, 50 route entries per route table
- **Association**: Each subnet can only associate with one route table
- **Multiple Assignment**: One route table can be assigned to multiple subnets
- **Default Assignment**: Subnets without specified route table assigned to main route table
- **Main Route Table**: Cannot be deleted, but can manually set another as main
- **Default Rule**: Allows all VPC subnets to communicate (cannot be deleted/modified)

---

## Subnets and Subnet Sizing

### Subnet Types
- **Public Subnet**: Traffic routed to Internet Gateway
- **Private Subnet**: No route to Internet Gateway
- **VPN-only Subnet**: No Internet Gateway route, but traffic routed to Virtual Private Gateway

### IP Address Management
- **CIDR Block**: VPC created with master address range (16-28 bits)
- **Subnet Ranges**: Created within VPC CIDR range
- **Restrictions**: Cannot change CIDR after creation, no overlapping blocks
- **Reserved IPs**: First 4 and last 1 IP addresses in subnet are reserved

#### Example Reserved IPs (10.0.0.0/24):
- `10.0.0.0`: Network address
- `10.0.0.1`: Reserved by AWS for VPC router
- `10.0.0.2`: Reserved by AWS
- `10.0.0.3`: Reserved by AWS for future use
- `10.0.0.255`: Network broadcast address

### Subnet Characteristics
- **AZ Mapping**: Subnets map 1:1 to AZs and cannot span zones
- **Default Association**: New subnets always associated with default route table
- **Recommended CIDR Ranges** (RFC 1918):
  - `10.0.0.0 – 10.255.255.255` (10/8 prefix)
  - `172.16.0.0 – 172.31.255.255` (172.16/12 prefix)
  - `192.168.0.0 – 192.168.255.255` (192.168/16 prefix)
- **Block Size**: Between /28 and /16 netmask
- **IPv6**: All IPv6 addresses are public, range allocated by AWS

---

## Internet Gateways (IGW)

### Overview
- Horizontally scaled, redundant, and highly available VPC component
- Enables communication between VPC instances and Internet

### Dual Purpose
1. Provide target in VPC route tables for Internet-routable traffic
2. Perform Network Address Translation (NAT) for instances with public IPv4 addresses

### Key Characteristics
- **Availability**: No availability risk or bandwidth constraints
- **Limitation**: Only one IGW per VPC
- **Scalability**: Horizontally scaled, redundant and HA
- **NAT Function**: Performs NAT between private and public IPv4 addresses
- **Protocol Support**: IPv4 and IPv6
- **Management**: Must be detached before deletion

### Internet Access Requirements
To enable Internet access for VPC instances:
1. Attach Internet Gateway to VPC
2. Update subnet route table to point to IGW
3. Ensure instances have globally unique IP address
4. Configure security groups and NACLs for traffic flow

### Egress-only Internet Gateway
- **Purpose**: Outbound Internet access for IPv6 instances
- **Security**: Prevents inbound access to IPv6 instances
- **Behavior**: Stateful - forwards traffic to Internet and returns responses
- **Routing**: Requires custom route for ::/0
- **Use Case**: Replacement for NAT Gateway for IPv6 traffic

---

## VPC Wizard Configurations

### 1. Single Public Subnet
- Private, isolated AWS section with direct Internet access
- Creates /16 network with /24 subnet
- Uses Elastic IPs or Public IPs for Internet access

### 2. Public and Private Subnets
- Adds private subnet not addressable from Internet
- Private instances use NAT for Internet access
- Creates /16 network with two /24 subnets

### 3. Public/Private Subnets + Hardware VPN
- Adds IPsec VPN connection to data center
- Extends data center to cloud
- One subnet Internet-connected, other connected via VPN

### 4. Private Subnet Only + Hardware VPN
- Private subnet with VPN connection to corporate network
- No direct Internet connectivity
- Creates /16 network with /24 subnet and IPsec VPN

---

## NAT Instances vs NAT Gateways

### NAT Instances (Customer Managed)
- **Management**: Customer managed
- **Placement**: Must be in public subnet with IGW route
- **Configuration**: Disable source/destination check
- **Security**: Assigned to security groups
- **Routing**: Private subnets need route to NAT instance (0.0.0.0/0)
- **Performance**: Based on instance type, can create bottlenecks
- **HA**: Not inherently HA, requires Auto Scaling groups and scripting
- **Additional Uses**: Can serve as bastion host, supports traffic monitoring
- **IPv6**: Not supported

### NAT Gateways (AWS Managed)
- **Management**: Fully managed by AWS
- **Placement**: Must be created in public subnet
- **IP Assignment**: Uses Elastic IP address
- **Bandwidth**: Up to 5 Gbps, scales to 45 Gbps
- **HA**: Highly available within AZ
- **Security**: Not associated with security groups
- **Limitations**: Cannot access via SSH, no port forwarding, no bastion host capability
- **Multi-AZ**: Create separate NAT Gateways in each AZ for redundancy

### Comparison Table
| Feature | NAT Gateway | NAT Instance |
|---------|-------------|--------------|
| Managed | AWS Managed | Customer Managed |
| Availability | Highly available within AZ | Requires scripting for HA |
| Bandwidth | Up to 45 Gbps | Depends on EC2 instance |
| Maintenance | AWS managed | Customer managed |
| Performance | Optimized for NAT | Amazon Linux 2 AMI |
| Public IP | Elastic IP (cannot detach) | Elastic IP (can detach) |
| Security Groups | Cannot associate | Can associate |
| Bastion Host | Not supported | Supported |

---

## Security Groups

### Overview
- Act as firewall at instance (network interface) level
- Stateful - return traffic automatically allowed
- Only permit rules allowed (no deny rules)
- Implicit deny rule at end

### Default Behavior
- **Custom Security Groups**: No inbound allow rules (all denied by default)
- **Default Security Groups**: Have inbound allow rules (traffic within group allowed)
- **Outbound Traffic**: All outbound traffic allowed by default

### Key Characteristics
- **Rule Evaluation**: All rules evaluated until permit found or implicit deny
- **Statefulness**: Return traffic for allowed inbound traffic automatically permitted
- **Membership**: Can be within any AZ or subnet within VPC
- **Dynamic Changes**: Membership can be changed while instances running
- **Immediate Effect**: Changes take effect immediately
- **Limits**: Up to 5 security groups per EC2 instance interface
- **Cross-referencing**: Can use security group names as source/destination
- **Self-referencing**: Can use own security group name as source

### Limitations
- Cannot block specific IP addresses (use NACLs instead)
- Cannot specify deny rules

---

## Network Access Control Lists (NACLs)

### Overview
- Function at subnet level
- Hosted by VPC router
- Support both permit and deny rules
- Stateless - responses subject to rules for each direction

### Rule Processing
- **Numbered List**: Rules evaluated in order from lowest number
- **Explicit Deny**: Processing continues until explicit deny
- **Spacing**: Recommended to leave spacing between rule numbers
- **Separate Rules**: Separate inbound and outbound rules

### Default Behavior
- **Default NACL**: Allows all inbound/outbound traffic
- **Custom NACL**: Denies all traffic by default
- **Subnet Association**: All subnets must be associated with NACL
- **Automatic Association**: Unspecified subnets use default NACL

### Key Characteristics
- **Subnet Coverage**: Only applies to traffic ingress/egress to subnet, not within subnet
- **Association**: One NACL per subnet, but NACL can associate with multiple subnets
- **Traffic Filtering**: Do not filter traffic between instances in same subnet
- **IP Blocking**: Preferred for blocking specific IPs or ranges
- **Defense Layer**: First line of defense (NACL), second line (Security Groups)
- **Changes**: Take effect immediately

### Security Groups vs NACLs Comparison
| Feature | Security Group | Network ACL |
|---------|----------------|-------------|
| Level | Instance (interface) | Subnet |
| Rules | Allow only | Allow and deny |
| State | Stateful | Stateless |
| Processing | Evaluates all rules | Processes in order |
| Application | Only if associated | Automatic for subnet instances |

---

## VPC Connectivity Options

### 1. AWS Managed VPN
- **What**: AWS-provided network connectivity using IPsec
- **When**: Quick, cost-effective secure connection needed
- **Requirements**: Virtual Private Gateway (AWS side), Customer Gateway (customer side)
- **Configuration**: Two tunnels per connection for redundancy
- **Limitations**: Cannot access Elastic IPs via VPN
- **Routing**: Route propagation requires pointing to VGW

### 2. AWS Direct Connect
- **What**: Dedicated network connection over private lines
- **When**: Large network link requirements, predictable performance needed
- **Benefits**: Up to 10 Gbps, reduced costs, consistent performance
- **Considerations**: Requires telecom relationships, higher cost
- **Security**: Does not encrypt traffic in transit
- **Virtual Interfaces**: Private VIFs (VPC) and Public VIFs (S3, Glacier)

### 3. Direct Connect + VPN
- **What**: IPsec VPN over Direct Connect
- **When**: Need security of encrypted tunnels over Direct Connect
- **Benefits**: Combines Direct Connect performance with VPN security
- **Use Case**: End-to-end secure IPsec connection

### 4. AWS VPN CloudHub
- **What**: Hub-and-spoke model using Virtual Private Gateway
- **When**: Multiple branch offices need connectivity
- **Configuration**: Multiple Customer Gateways to single VGW
- **Features**: Up to 10 IPsec tunnels, uses eBGP, branch-to-branch communication
- **Cost**: Hourly rates plus data egress charges

### 5. Software VPN
- **What**: Customer-managed VPN endpoints
- **When**: Need full control for compliance or unsupported options
- **Implementation**: VPN software on EC2 via Marketplace
- **Responsibility**: Customer designs redundancy

### 6. Transit VPC
- **What**: Global network transit center
- **When**: Multiple geographically dispersed VPCs need connectivity
- **Providers**: Cisco, Juniper, Riverbed offerings
- **Benefits**: Simplified network management, reduced connections

---

## VPC Peering

### Overview
- **What**: AWS-provided network connectivity between two VPCs
- **When**: Multiple VPCs need to communicate and access resources
- **How**: Peering request made and accepted (within or across accounts)

### Key Characteristics
- **Network**: Uses existing VPC infrastructure
- **Architecture**: Not a gateway or VPN, no single point of failure
- **Relationship**: One-to-one relationship between VPCs
- **Transitivity**: Transitive peering NOT supported
- **Limits**: 50 VPC peers per VPC (up to 125 by request)
- **CIDR**: Cannot have overlapping CIDR ranges

### Regional Support
- **Intra-region**: Full feature support
- **Inter-region**: Some limitations exist
  - Cannot reference peer security groups in rules
  - Cannot enable DNS resolution
  - Maximum MTU 1500 bytes (no jumbo frames)
  - Limited region support
- **Encryption**: Inter-region traffic is encrypted

### Configuration Requirements
- Update route tables for routing configuration
- Update security group rules to reference peered VPC security groups
- Cross-account peering requires account ID and VPC ID
- Accept pending access requests
- Route table target begins with "pcx-"

---

## AWS PrivateLink and VPC Endpoints

### AWS PrivateLink
- **Purpose**: Private connectivity between VPCs, AWS services, and on-premises
- **Benefits**: Eliminates public Internet exposure, uses AWS backbone
- **Architecture**: Simplifies network architecture across accounts and VPCs
- **Security**: Keeps private subnets truly private

### VPC Endpoints Types

#### Interface Endpoints
- **Technology**: Uses AWS PrivateLink
- **Implementation**: Elastic Network Interface (ENI) with private IP
- **DNS**: Uses DNS entries to redirect traffic
- **Services**: Large number of AWS services supported
- **IAM**: Requires specific permissions for users

#### Gateway Endpoints
- **Implementation**: Gateway target for specific route in route table
- **Routing**: Uses prefix lists in route table
- **Services**: Only Amazon S3 and DynamoDB
- **Cost**: No additional charges

### VPC Endpoint Services
- Connect to services hosted by other AWS accounts
- Supported AWS Marketplace partner services
- Cross-region access via Inter-Region VPC Peering

### Key Differences
| Feature | Interface Endpoint | Gateway Endpoint |
|---------|-------------------|------------------|
| Type | ENI with private IP | Route table target |
| DNS | DNS entries | Prefix lists |
| Services | Most AWS services | S3 and DynamoDB only |

---

## VPC Sharing

### Overview
Enables subnets to be shared with other AWS accounts within same AWS Organization

### Benefits
- **Separation of Duties**: Centrally controlled VPC structure and routing
- **Resource Ownership**: Application owners maintain resource control
- **Security Groups**: Participants can reference each other's security group IDs
- **Efficiency**: Higher subnet density, efficient VPN/Direct Connect use
- **Cost Optimization**: Reuse of NAT Gateways, VPC endpoints
- **Limit Avoidance**: Avoid hard limits like 50 VIFs per Direct Connect

### Use Cases
- IT team manages VPCs, developers access as needed
- Applications requiring high interconnectivity within trust boundaries
- Reduced VPC management overhead
- Integration with PrivateLink, Transit Gateway, VPC Peering

---

## VPC Flow Logs

### Overview
Capture IP traffic information to/from network interfaces in VPC

### Configuration Levels
- **VPC Level**: All interfaces in VPC
- **Subnet Level**: All interfaces in subnet
- **Network Interface Level**: Specific interface

### Storage and Analysis
- **Storage**: Amazon CloudWatch Logs
- **Analysis**: Use CloudWatch Logs insights or export to S3

### Limitations
- Cannot enable for peered VPCs (unless in same account)
- Cannot tag flow logs
- Cannot change configuration after creation (delete and recreate required)

### Excluded Traffic
- Route 53 traffic
- Windows license activation traffic
- Instance metadata (169.254.169.254)
- Amazon Time Sync Service (169.254.169.123)
- DHCP traffic
- Default VPC router traffic

---

## High Availability Best Practices

### Multi-AZ Design
- Create subnets in available AZs for Multi-AZ presence
- Deploy resources across multiple AZs

### VPN Redundancy
- Create at least two VPN tunnels into Virtual Private Gateway
- Use multiple Customer Gateways when possible

### Direct Connect HA
- Establish secondary connection via another Direct Connect
- Use different providers for redundancy
- Backup with VPN connection

### DNS and IP Management
- Use Route 53 health checks for DNS failover
- Implement Elastic IPs for flexibility
- Plan for IP address mobility

### NAT Gateway Redundancy
- Create NAT Gateways in each AZ
- Configure routes for private subnets to use local gateway
- Avoid single points of failure

---

## Exam Focus Areas

### Key Concepts to Remember
- VPC components and their functions
- Difference between Security Groups and NACLs
- NAT Instance vs NAT Gateway comparison
- VPC Peering limitations (no transitivity)
- Gateway vs Interface endpoints (S3/DynamoDB vs others)
- Reserved IP addresses in subnets
- Default VPC characteristics
- Multi-AZ design patterns for high availability

### Common Exam Scenarios
- Choosing appropriate connectivity option (VPN, Direct Connect, etc.)
- Troubleshooting connectivity issues
- Security group vs NACL rule configuration
- VPC endpoint selection for different services
- High availability architecture design