# AWS KMS - Comprehensive Study Notes

## Overview
AWS Key Management Service (KMS) is a managed service that enables easy data encryption. It provides highly available key storage, management, and auditing solutions for encrypting data within applications and controlling encryption across AWS services.

**Key Image Reference**: The article includes the main AWS KMS services diagram showing the core components and workflow.

---

## KMS Keys (Formerly Customer Master Keys - CMKs)

### Key Components
A KMS key consists of:
- **Alias** - Friendly name for the key
- **Creation date** - When the key was created
- **Description** - Purpose/details about the key
- **Key state** - Current status of the key
- **Key material** - Either customer provided or AWS provided

### Key Characteristics
- Primary resources in AWS KMS
- Contains metadata (key ID, creation date, description, key state)
- Contains key material for encrypt/decrypt operations
- Supports both symmetric and asymmetric keys
- Keys are created in AWS KMS and never leave AWS KMS unencrypted
- Can encrypt data up to **4KB in size**
- Can generate, encrypt, and decrypt Data Encryption Keys (DEKs)
- **Cannot be exported from KMS** (unlike CloudHSM)

**Key Image Reference**: AWS KMS CMKs diagram illustrating the different types of customer managed keys.

---

## Types of KMS Keys

### 1. AWS Managed KMS Keys
- Managed by AWS for AWS services that interact with KMS
- Can only be used by the service that created them within a particular region
- Created automatically when first implementing encryption with that service
- **No monthly fee** but subject to usage fees beyond free tier
- Cannot be managed, rotated, or have key policies changed

### 2. Customer Managed KMS Keys
- Created, owned, and managed by you
- **Full control** including:
  - Key policies and IAM policies
  - Grants management
  - Enable/disable functionality
  - Key rotation
  - Adding tags and aliases
  - Scheduling for deletion
- **Incur monthly fee** and usage fees beyond free tier

### 3. AWS Owned KMS Keys
- Collection of keys owned and managed by AWS services
- Used across multiple AWS accounts
- Not visible in your account
- Cannot view, use, track, or audit them
- **No charges** and don't count against quotas

---

## Data Encryption Keys (DEKs)

### Purpose and Function
- Encryption keys used to encrypt data, including large amounts of data
- Generated using KMS keys via `GenerateDataKey` API
- AWS KMS does **not store, manage, or track** data keys
- Must be managed outside of AWS KMS

**Key Image Reference**: Amazon KMS data encryption keys diagram showing the relationship between KMS keys and data encryption keys.

### Workflow
1. KMS key encrypts the data key (envelope key)
2. Envelope key is used to decrypt the data
3. Encrypted data key is stored alongside encrypted data

---

## KMS Implementation Details

### Key Material Options
- **KMS generated** - Default option
- **Import your own** - Bring your own key material

### Security Features
- Protected by Hardware Security Modules (HSMs)
- Keys only used within HSM modules
- Can submit data directly to KMS for encryption/decryption
- **Encryption at rest only** (not in transit - use SSL for that)

### Integration
Tightly integrated with AWS services:
- Lambda
- S3
- EBS
- EFS
- DynamoDB
- SQS
- And many more

---

## Key Management Functions

You can perform these operations in AWS KMS:
- Create keys with unique alias and description
- Import your own key material
- Define IAM users/roles for key management
- Define IAM users/roles for encrypt/decrypt operations
- Enable automatic annual key rotation
- Temporarily disable keys
- Re-enable disabled keys
- Delete unused keys
- Audit key usage via CloudTrail
- Create/manage custom key stores (requires CloudHSM)

---

## Data Encryption Scenarios

### Three Primary Scenarios:
1. **Direct KMS API usage** - Use KMS APIs directly for encrypt/decrypt
2. **AWS service encryption** - Let AWS services encrypt using your KMS keys
3. **AWS Encryption SDK** - Integrate encryption within your applications

---

## Custom Key Store

### Features
- Combines AWS CloudHSM controls with KMS ease of use
- Configure your own CloudHSM cluster
- KMS uses it as dedicated key store
- Keys generated in CloudHSM cluster
- Master keys never leave HSMs in plaintext
- All operations performed in your HSMs

---

## Key Deletion

### Process
- Schedule deletion with **7-30 day waiting period**
- Default waiting period: **30 days**
- Can cancel deletion during waiting period
- Allows verification of impact on applications

---

## Important KMS APIs

### Core Operations
- **`aws kms encrypt`** - Encrypts plaintext to ciphertext (up to 4KB)
- **`aws kms decrypt`** - Decrypts KMS-encrypted ciphertext
- **`aws kms re-encrypt`** - Changes KMS key or encryption context
- **`enable-key-rotation`** - Enables automatic key rotation
- **`aws kms generate-data-key`** - Creates data encryption keys
- **`generate-data-key-without-plaintext`** - Creates encrypted data keys only

---

## Envelope Encryption

### Concept
KMS uses envelope encryption method:
1. KMS generates data keys
2. Data keys encrypt actual data
3. Data keys are encrypted by KMS master keys
4. Encrypted data key stored with encrypted data
5. To decrypt: KMS decrypts data key, data key decrypts data

---

## Limits and Constraints

### Key Limits
- **1,000 KMS keys per account per region**
- Both enabled and disabled keys count toward limit
- AWS managed keys don't count against limit
- No limit on number of data keys derived from master key

---

## Exam Tips and Key Points

### Critical Facts for Exams
- **Encryption keys are regional**
- KMS is for **encryption at rest only**
- Keys **cannot be exported** from KMS
- Maximum **4KB data size** for direct encryption
- **CloudTrail integration** for auditing
- Different from **Secrets Manager** (purpose-built for encryption key management)
- Validated by compliance schemes (PCI DSS Level 1, FIPS 140-2 Level 2)

### Access Control
- Control key management and access via **IAM users and roles**
- Audit key usage via **CloudTrail**
- Set usage policies determining who can use keys and under what conditions

---

## Monitoring and Compliance

### Auditing
- All master key requests logged in **AWS CloudTrail**
- Track who used which key, when, and under what context
- Understand usage patterns and access controls

### Compliance
- Validated by multiple compliance schemes
- PCI DSS Level 1
- FIPS 140-2 Level 2
- Suitable for regulated industries and sensitive data